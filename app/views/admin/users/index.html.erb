<% content_for :page_title, "Users" %>

<div class="admin-actions-bar">
  <div class="admin-search">
    <%= form_with(url: admin_users_path, method: :get, local: true, class: "search-form") do |form| %>
      <%= form.text_field :search, placeholder: "Search users...", value: params[:search] %>
      <%= form.hidden_field :role, value: params[:role] %>
      <%= form.hidden_field :status, value: params[:status] %>
    <% end %>
  </div>

  <div class="admin-filters">
    <%= form_with(url: admin_users_path, method: :get, local: true, class: "filter-form") do |form| %>
      <%= form.select :role,
            options_for_select([["All Roles", ""]] + @role_options, params[:role]),
            {},
            {
              class: "role-filter-select",
              onchange: "this.form.submit();"
            } %>
      <%= form.select :status,
            options_for_select([["All Status", ""]] + @status_options, params[:status]),
            {},
            {
              class: "status-filter-select",
              onchange: "this.form.submit();"
            } %>
      <%= form.hidden_field :search, value: params[:search] %>
    <% end %>
  </div>

  <div class="admin-actions">
    <%= link_to "Add New User", new_admin_user_path, class: "admin-btn admin-btn-primary" %>
  </div>
</div>

<div class="admin-table">
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Country</th>
        <th>Role</th>
        <th style="text-align: center;">Terms Version</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @users.each do |user| %>
        <tr>
          <td><%= user.display_name %></td>
          <td><%= user.email %></td>
          <td><%= user.country_of_residence %></td>
          <td>
            <% if user.admin? %>
              <span class="admin-badge admin-badge-admin">Admin</span>
            <% else %>
              <span class="admin-badge admin-badge-user">User</span>
            <% end %>
          </td>
          <td style="text-align: center;">
            <% if user.terms_version %>
              <span class="admin-badge admin-badge-info"><%= user.terms_version %></span>
            <% else %>
              <span class="admin-badge admin-badge-secondary">-</span>
            <% end %>
          </td>
          <td>
            <% if user.confirmed? %>
              <span class="admin-badge admin-badge-user">Confirmed</span>
            <% else %>
              <span class="admin-badge admin-badge-admin">Pending</span>
            <% end %>
          </td>
          <td class="actions-cell">
            <%= link_to "View", admin_user_path(user), class: "admin-btn admin-btn-sm admin-btn-secondary" %>
            <%= link_to "Edit", edit_admin_user_path(user), class: "admin-btn admin-btn-sm admin-btn-primary" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @users.empty? %>
    <div style="padding: 40px; text-align: center; color: #6b7280;">
      <% filters_applied = [params[:search], params[:role], params[:status]].any?(&:present?) %>
      <% if filters_applied %>
        <% filter_description = [] %>
        <% filter_description << "\"#{params[:search]}\"" if params[:search].present? %>
        <% filter_description << "role: #{params[:role].humanize}" if params[:role].present? %>
        <% filter_description << "status: #{params[:status].humanize}" if params[:status].present? %>
        No users found matching <%= filter_description.join(', ') %>
      <% else %>
        No users found.
      <% end %>
    </div>
  <% end %>
</div>

<div class="admin-pagination">
  <%= paginate @users %>
</div>

<style>
/* Filter styles */
.admin-actions-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.admin-filters {
  display: flex;
  align-items: center;
  gap: 12px;
}

.filter-form {
  margin: 0;
  display: flex;
  gap: 12px;
}

.role-filter-select,
.status-filter-select {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  color: #374151;
  min-width: 120px;
  cursor: pointer;
}

.role-filter-select:focus,
.status-filter-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Actions cell - prevent button wrapping */
.actions-cell {
  white-space: nowrap;
  width: 120px;
}

.actions-cell .admin-btn {
  margin-right: 4px;
}

.actions-cell .admin-btn:last-child {
  margin-right: 0;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .admin-actions-bar {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .admin-filters {
    justify-content: center;
    flex-wrap: wrap;
  }

  .filter-form {
    flex-wrap: wrap;
    justify-content: center;
  }

  .role-filter-select,
  .status-filter-select {
    min-width: 140px;
  }

  .actions-cell {
    width: auto;
  }

  .admin-actions {
    text-align: center;
  }
}
</style>
