<%= form_with model: [:admin, @mortgage, @mortgage_contract], local: true, class: "admin-form" do |form| %>
  <% if @mortgage_contract.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(@mortgage_contract.errors.count, "error") %> prohibited this Mortgage Contract from being saved:</h4>
      <ul>
        <% @mortgage_contract.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="admin-form-group">
    <%= form.label :title, class: "admin-form-label" %>
    <%= form.text_field :title, class: "admin-form-input", placeholder: "e.g., Equity Preservation Mortgage Contract" %>
  </div>

  <div style="margin-bottom: 20px;"></div>

  <div class="admin-form-group">
    <% if @mortgage_contract.persisted? %>
      <label class="admin-form-label">Version & Status</label>
      <div class="version-status-info">
        <div class="admin-form-input" style="background: #f8f9fa; border: 1px solid #e9ecef; color: #6c757d; display: inline-block; width: auto; margin-right: 12px;">
          Version <%= @mortgage_contract.version %>
        </div>
        <span class="admin-badge admin-badge-<%= @mortgage_contract.status_color %>"><%= @mortgage_contract.status %></span>
      </div>
    <% else %>
      <label class="admin-form-label">Version</label>
      <div class="admin-form-input" style="background: #f8f9fa; border: 1px solid #e9ecef; color: #6c757d;">
        Version <%= (MortgageContract.maximum(:version) || 0) + 1 %> (new contract)
      </div>
    <% end %>
  </div>

  <div style="margin-bottom: 20px;"></div>

  <div class="admin-form-group">
    <%= form.label :content, "Contract Content (using simple markup)", class: "admin-form-label" %>
    <div class="markup-help">
      <p><strong>Mortgage Contract Markup Guide:</strong></p>
      <ul>
        <li><code>## Section Title</code> → Creates a main section with heading</li>
        <li><code>### Sub-section</code> → Creates a sub-section</li>
        <li><code>- Bullet point</code> → Creates bulleted lists</li>
        <li><code>**Bold text**</code> → Makes text bold</li>
        <li><code>**Field:** Value</code> → Creates structured loan details</li>
        <li><code>Lender: Name</code> → Contact information block</li>
      </ul>
    </div>
    
    <%= form.text_area :content, 
        class: "admin-form-textarea markup-editor", 
        rows: 30,
        placeholder: 'Use simple markup to format your contract content. See the guide above for examples.' %>
  </div>

  <div class="admin-form-actions" style="margin-top: 32px;">
    <% if @mortgage_contract.persisted? %>
      <% if @mortgage_contract.draft? %>
        <%= form.submit "Update Contract", class: "admin-btn admin-btn-primary" %>
      <% else %>
        <%= form.submit "Create New Version", class: "admin-btn admin-btn-primary" %>
      <% end %>
    <% else %>
      <%= form.submit "Create Contract (Draft)", class: "admin-btn admin-btn-primary" %>
    <% end %>
    <button type="button" id="preview-btn" class="admin-btn admin-btn-success">Preview Contract</button>
    <%= link_to "Cancel", admin_mortgage_mortgage_contracts_path(@mortgage), class: "admin-btn admin-btn-secondary" %>
  </div>
<% end %>

<style>
.markup-help {
  background: #f0f9ff;
  border: 1px solid #0ea5e9;
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 10px;
}

.markup-help p {
  margin: 0 0 10px 0;
  color: #0369a1;
  font-weight: 600;
}

.markup-help ul {
  margin: 0;
  padding-left: 20px;
}

.markup-help li {
  margin-bottom: 5px;
  color: #0369a1;
}

.markup-help code {
  background: #e0f2fe;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: Monaco, monospace;
  font-size: 13px;
}

.markup-editor {
  font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
  font-size: 14px;
  line-height: 1.5;
  border: 2px solid #e2e8f0;
  border-radius: 6px;
  background-color: #f8fafc;
  resize: vertical;
  width: 100%;
}

.markup-editor:focus {
  border-color: #3b82f6;
  outline: none;
  background-color: white;
}

.version-status-info {
  display: flex;
  align-items: center;
}

.preview-note {
  color: #6b7280;
  font-style: italic;
  text-align: center;
  margin: 60px 0;
}

/* Preview content styling - match legal page styles */
.markup-preview .legal-section {
  margin-bottom: 30px;
}

.markup-preview .legal-section h2 {
  color: #0891b2;
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 12px 0;
  padding-bottom: 6px;
  border-bottom: 2px solid #0891b2;
}

.markup-preview .legal-section h3 {
  color: #1e293b;
  font-size: 16px;
  font-weight: 600;
  margin: 20px 0 10px 0;
}

.markup-preview .legal-section p {
  color: #1e293b;
  line-height: 1.6;
  margin: 0 0 12px 0;
}

.markup-preview .legal-section ul {
  margin: 12px 0;
  padding-left: 20px;
}

.markup-preview .legal-section li {
  color: #1e293b;
  line-height: 1.5;
  margin-bottom: 6px;
}

.markup-preview .loan-details {
  background-color: #fef3c7;
  padding: 16px;
  border-radius: 8px;
  border-left: 4px solid #f59e0b;
  margin: 12px 0;
}

.markup-preview .detail-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding: 4px 0;
  border-bottom: 1px solid #fde68a;
}

.markup-preview .detail-row:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.markup-preview .contact-info {
  background-color: #f8fafc;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #0891b2;
  margin: 12px 0;
}

.markup-preview .contact-info p {
  margin: 0 0 8px 0;
  line-height: 1.5;
}

.markup-preview .contact-info p:last-child {
  margin-bottom: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const previewBtn = document.getElementById('preview-btn');
  const contentTextarea = document.querySelector('[name="mortgage_contract[content]"]');
  const titleInput = document.querySelector('[name="mortgage_contract[title]"]');
  
  if (previewBtn && contentTextarea) {
    previewBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Create form data
      const formData = new FormData();
      formData.append('mortgage_contract[title]', titleInput.value);
      formData.append('mortgage_contract[content]', contentTextarea.value);
      
      // Open preview in new window
      const previewWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
      previewWindow.document.write('<html><body><h3>Loading preview...</h3></body></html>');
      
      // Submit to preview endpoint
      fetch('<%= preview_admin_mortgage_mortgage_contracts_path(@mortgage) %>', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
        }
      })
      .then(response => response.text())
      .then(html => {
        previewWindow.document.open();
        previewWindow.document.write(html);
        previewWindow.document.close();
      })
      .catch(error => {
        previewWindow.document.write('<html><body><h3>Error loading preview</h3><p>' + error + '</p></body></html>');
      });
    });
  }
});
</script>