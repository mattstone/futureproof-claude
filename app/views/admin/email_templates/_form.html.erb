<div class="email-template-editor" data-controller="email-template-editor">
  <!-- Left Column - Form -->
  <div class="email-editor-form">
    <%= form_with(model: [:admin, @email_template], local: true, html: { class: "admin-form", id: "email-template-form", "data-action": "submit->email-template-editor#formSubmit" }) do |form| %>
      <% if @email_template.errors.any? %>
        <div class="admin-form-errors">
          <h4><%= pluralize(@email_template.errors.count, "error") %> prohibited this template from being saved:</h4>
          <ul>
            <% @email_template.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

  <div class="admin-form-group">
    <%= form.label :name, class: "admin-form-label" %>
    <%= form.text_field :name, class: "admin-form-input", placeholder: "Enter template name" %>
  </div>

  <div class="admin-form-group">
    <%= form.label :template_type, "Template Type", class: "admin-form-label" %>
    <%= form.select :template_type, 
        options_for_select([
          ['Email Verification', 'verification'],
          ['Application Submitted', 'application_submitted'],
          ['Security Notification', 'security_notification']
        ], @email_template.template_type), 
        { prompt: 'Select template type' }, 
        { class: "admin-form-select", id: "template_type_select", 
          "data-email-template-editor-target": "templateType",
          "data-action": "change->email-template-editor#templateTypeChanged" } %>
  </div>

  <div class="admin-form-group">
    <%= form.label :email_category, "Email Category", class: "admin-form-label" %>
    <%= form.select :email_category, 
        options_for_select([
          ['Operational (System notifications, account updates)', 'operational'],
          ['Marketing (Promotional content, newsletters)', 'marketing']
        ], @email_template.email_category), 
        { prompt: 'Select email category' }, 
        { class: "admin-form-select", id: "email_category_select", 
          "data-email-template-editor-target": "emailCategory",
          "data-action": "change->email-template-editor#emailCategoryChanged" } %>
    <small class="form-text text-muted">
      Operational emails use standard headers/footers, marketing emails use enhanced branding and social links.
    </small>
  </div>

  <div class="admin-form-group">
    <%= form.label :description, class: "admin-form-label" %>
    <%= form.text_area :description, class: "admin-form-textarea", rows: 2, placeholder: "Brief description of when this template is used" %>
  </div>

  <div class="admin-form-group">
    <%= form.label :subject, class: "admin-form-label" %>
    <%= form.text_field :subject, class: "admin-form-input", placeholder: "Email subject line (supports field placeholders)", 
        id: "email_template_subject",
        "data-email-template-editor-target": "subject",
        "data-action": "input->email-template-editor#subjectChanged" %>
  </div>

  <div class="admin-form-group">
    <%= form.label :content_body, "Email Content Body", class: "admin-form-label" %>
    <div class="content-editor-section">
      <div class="editor-tabs">
        <button type="button" id="rich-tab" class="editor-tab active" 
                data-email-template-editor-target="richTab"
                data-action="click->email-template-editor#switchToRich">Rich Text Editor</button>
        <button type="button" id="html-tab" class="editor-tab" 
                data-email-template-editor-target="htmlTab"
                data-action="click->email-template-editor#switchToHtml">HTML Source</button>
        <button type="button" id="markup-tab" class="editor-tab"
                data-email-template-editor-target="markupTab" 
                data-action="click->email-template-editor#switchToMarkup">Markup Editor</button>
      </div>
      
      <div class="field-helper-section">
        <div id="field-helper-panel" style="margin-top: 12px; padding: 16px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px;"
             data-email-template-editor-target="fieldHelper">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0; color: #374151;">Available Field Placeholders</h4>
            <button type="button" id="toggle-field-helper" class="admin-btn admin-btn-sm admin-btn-secondary"
                    data-email-template-editor-target="toggleFieldHelper"
                    data-action="click->email-template-editor#toggleFieldHelper">Hide Fields</button>
          </div>
          <div id="field-helper-content" data-email-template-editor-target="fieldHelperContent">
            <p class="text-muted">Select a template type to see available fields</p>
          </div>
        </div>
      </div>
      
      <div class="editor-note" style="margin-bottom: 12px; padding: 12px; background: #e3f2fd; border: 1px solid #bae6fd; border-radius: 4px;">
        <small class="text-muted" style="color: #0369a1;">
          <strong>Note:</strong> This editor is for the main email content only. Standard headers and footers will be automatically added based on the email category selected above.
        </small>
      </div>
      
      <!-- Rich Text Editor -->
      <div id="rich-editor-section" class="editor-section" data-email-template-editor-target="richSection" data-controller="tinymce">
        <%= form.text_area :content_body, class: "admin-form-textarea rich-text-editor", rows: 15, 
            placeholder: "Use the rich text editor to format your email content. Field placeholders like {{user.first_name}} can be inserted using the Fields button in the toolbar.",
            id: "rich-content", 
            "data-email-template-editor-target": "richContent",
            "data-tinymce-target": "editor",
            "data-action": "input->email-template-editor#contentChanged" %>
      </div>
      
      <!-- HTML Editor -->
      <div id="html-editor-section" class="editor-section" style="display: none;" data-email-template-editor-target="htmlSection">
        <%= form.text_area :content_body, class: "admin-form-textarea email-editor", rows: 20, placeholder: "Email body content (HTML format, supports field placeholders)\n\nHeaders and footers will be automatically added based on email category.", 
            id: "html-content", 
            "data-email-template-editor-target": "htmlContent",
            "data-action": "input->email-template-editor#contentChanged" %>
      </div>
      
      <!-- Markup Editor -->
      <div id="markup-editor-section" class="editor-section" style="display: none;" data-email-template-editor-target="markupSection">
        <%= form.text_area :markup_content, class: "admin-form-textarea markup-editor", rows: 20, placeholder: "Use simplified markup for body content:\n\n## Section Title\nRegular paragraph text.\n\n### Subsection\n- Bullet point\n- Another bullet\n\n**Bold text**\n*Italic text*\n\nSupports all field placeholders like {{user.first_name}}\n\nHeaders and footers will be automatically added.", 
            id: "markup-content",
            "data-email-template-editor-target": "markupContent",
            "data-action": "input->email-template-editor#contentChanged" %>
        <div class="markup-help">
          <small class="text-muted">
            <strong>Markup Guide:</strong><br>
            <code>## Title</code> = Large heading<br>
            <code>### Subtitle</code> = Smaller heading<br>
            <code>**bold text**</code> = <strong>Bold</strong><br>
            <code>*italic text*</code> = <em>Italic</em><br>
            <code>- item</code> = Bullet point<br>
            Line breaks create paragraphs
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden field for backward compatibility -->
  <%= form.hidden_field :content, value: @email_template.content || "" %>

  <div class="admin-form-group">
    <div class="admin-form-checkbox-group">
      <%= form.check_box :is_active, class: "admin-form-checkbox" %>
      <%= form.label :is_active, "Active (will be used for emails of this type)", class: "admin-form-checkbox-label" %>
    </div>
  </div>

  <div class="admin-form-actions">
    <div class="admin-form-actions-left">
      <% if @email_template.persisted? %>
        <%= link_to "Preview", preview_admin_email_template_path(@email_template), class: "admin-btn admin-btn-info", target: "_blank", id: "preview-btn" %>
      <% end %>
    </div>
    <div class="admin-form-actions-right">
      <%= link_to "Cancel", admin_email_templates_path, class: "admin-btn admin-btn-secondary" %>
      <%= form.submit class: "admin-btn admin-btn-primary" %>
    </div>
  </div>
    <% end %>
  </div>
  
  <!-- Right Column - Live Preview -->
  <div class="email-editor-preview">
    <div class="preview-header">
      <h3>Live Preview</h3>
      <div class="preview-controls">
        <button type="button" id="refresh-preview" class="admin-btn admin-btn-sm admin-btn-secondary"
                data-email-template-editor-target="refreshBtn"
                data-action="click->email-template-editor#refreshPreview">Refresh</button>
        <button type="button" id="toggle-sample-data" class="admin-btn admin-btn-sm admin-btn-info"
                data-email-template-editor-target="toggleSampleBtn"
                data-action="click->email-template-editor#toggleSampleData">Toggle Sample Data</button>
      </div>
    </div>
    
    <div class="preview-content">
      <div class="email-preview-frame">
        <div class="email-subject-preview">
          <strong>Subject:</strong> <span id="subject-preview" data-email-template-editor-target="subjectPreview">Preview will appear here...</span>
        </div>
        <hr>
        <div id="email-content-preview" class="email-body-preview" data-email-template-editor-target="contentPreview">
          <p class="text-muted">Start typing in the editor to see preview...</p>
        </div>
      </div>
    </div>
  </div>
</div>


<style>
/* Two-column layout */
.email-template-editor {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
  min-height: 100vh;
}

.email-editor-form {
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 24px;
}

.email-editor-preview {
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  padding: 24px;
  position: sticky;
  top: 24px;
  height: fit-content;
  max-height: calc(100vh - 48px);
  overflow-y: auto;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid #e5e7eb;
}

.preview-header h3 {
  margin: 0;
  color: #0891b2;
  font-size: 18px;
}

.preview-controls {
  display: flex;
  gap: 8px;
}

.email-preview-frame {
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 20px;
  background: #fafafa;
  font-family: Arial, sans-serif;
}

.email-subject-preview {
  margin-bottom: 16px;
  padding: 12px;
  background: white;
  border-radius: 4px;
  border-left: 4px solid #0891b2;
}

.email-body-preview {
  background: white;
  padding: 20px;
  border-radius: 4px;
  min-height: 300px;
  line-height: 1.6;
}

/* Editor tabs */
.editor-tabs {
  display: flex;
  margin-bottom: 16px;
  border-bottom: 1px solid #e5e7eb;
}

.editor-tab {
  background: none;
  border: none;
  padding: 12px 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #6b7280;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.editor-tab:hover {
  color: #374151;
  background: #f9fafb;
}

.editor-tab.active {
  color: #0891b2;
  border-bottom-color: #0891b2;
  background: #f0f9ff;
}

.editor-section {
  position: relative;
}

.markup-editor {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  line-height: 1.5;
  background: #fafafa;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 12px;
}

.email-editor {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  line-height: 1.5;
}

.rich-text-editor {
  border: 1px solid #d1d5db;
  border-radius: 4px;
}

/* TinyMCE specific styling */
.tox-tinymce {
  border: 1px solid #d1d5db !important;
  border-radius: 4px !important;
}

.tox .tox-editor-header {
  background: #f9fafb !important;
  border-bottom: 1px solid #e5e7eb !important;
}

.markup-help {
  margin-top: 8px;
  padding: 12px;
  background: #f0f9ff;
  border: 1px solid #bae6fd;
  border-radius: 4px;
}

.markup-help code {
  background: #e0f2fe;
  padding: 2px 4px;
  border-radius: 3px;
  font-size: 11px;
}

.field-helper-section {
  margin-bottom: 16px;
}

.field-tag:hover {
  background: #0891b2 !important;
  color: white !important;
}

.text-muted {
  color: #6b7280;
}

.admin-form-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
}

.admin-form-actions-left,
.admin-form-actions-right {
  display: flex;
  gap: 12px;
  align-items: center;
}

.admin-btn-success {
  background: #059669;
  color: white;
  border-color: #059669;
}

.admin-btn-success:hover {
  background: #047857;
  border-color: #047857;
}

/* Responsive design */
@media (max-width: 1400px) {
  .email-template-editor {
    grid-template-columns: 1fr;
    gap: 24px;
  }
  
  .email-editor-preview {
    position: static;
    max-height: none;
  }
}

@media (max-width: 768px) {
  .preview-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .preview-controls {
    width: 100%;
    justify-content: flex-start;
  }
  
  .editor-tabs {
    flex-wrap: wrap;
  }
}
</style>