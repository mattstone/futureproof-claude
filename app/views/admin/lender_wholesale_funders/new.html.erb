<% content_for :page_title, "Manage Wholesale Funders for #{@lender.name}" %>

<!-- Flash messages container -->
<div id="flash-messages" data-wholesale-funder-interface-target="flashMessages">
  <% if notice %>
    <div class="alert alert-success" id="temp-notice">
      <%= notice %>
    </div>
  <% end %>
</div>

<div class="wholesale-funders-interface" 
     data-controller="wholesale-funder-interface"
     data-wholesale-funder-interface-lender-id-value="<%= @lender.id %>"
     data-wholesale-funder-interface-add-wholesale-funder-url-value="<%= add_wholesale_funder_admin_lender_wholesale_funders_path(@lender) %>">
  <!-- Instructions -->
  <div class="interface-instructions">
    <div class="instructions-header">
      <div class="instructions-content">
        <h3>Select Wholesale Funders & Manage Pools</h3>
        <p>
          Tap on wholesale funder cards to select or deselect them. Once selected, 
          you can activate or deactivate specific funder pools by clicking the toggle buttons.
        </p>
      </div>
      <div class="instructions-actions">
        <%= link_to "Back to Lender", admin_lender_path(@lender), class: "admin-btn admin-btn-secondary" %>
      </div>
    </div>
  </div>

  <!-- Current Relationships Summary -->
  <% if @existing_relationships.any? %>
    <div class="current-relationships-summary">
      <h4>Current Relationships</h4>
      <div class="relationship-pills">
        <% @existing_relationships.each do |relationship| %>
          <div class="relationship-pill <%= relationship.active? ? 'active' : 'inactive' %>">
            <span class="relationship-name"><%= relationship.wholesale_funder.name %></span>
            <span class="relationship-status">
              <%= relationship.active? ? 'Active' : 'Inactive' %>
            </span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Wholesale Funders Cards -->
  <div class="wholesale-funders-grid" id="wholesale-funders-grid">
    <!-- Display existing relationships first (already connected) -->
    <% @existing_relationships.each do |relationship| %>
      <div class="wholesale-funder-card existing-relationship"
           data-wholesale-funder-id="<%= relationship.wholesale_funder.id %>"
           data-lender-id="<%= @lender.id %>">
        
        <!-- Card Header -->
        <div class="card-header">
          <div class="card-title">
            <h4><%= relationship.wholesale_funder.name %></h4>
            <div class="selection-indicator selected">
              <span class="selection-icon">✓</span>
            </div>
          </div>
          <div class="card-status" data-status="existing">
            <span class="status-text">Currently Connected</span>
          </div>
        </div>

        <!-- Card Details -->
        <div class="card-details">
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Country</span>
              <span class="detail-value"><%= relationship.wholesale_funder.country %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Currency</span>
              <span class="detail-value currency-badge currency-<%= relationship.wholesale_funder.currency.downcase %>">
                <%= relationship.wholesale_funder.currency_symbol %> <%= relationship.wholesale_funder.currency %>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status</span>
              <span class="detail-value">
                <span class="status-badge <%= relationship.active? ? 'status-active' : 'status-inactive' %>">
                  <%= relationship.status_display %>
                </span>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Total Capital</span>
              <span class="detail-value"><%= relationship.wholesale_funder.formatted_total_capital %></span>
            </div>
          </div>
        </div>

        <!-- Funder Pools (visible for existing relationships) -->
        <div class="funder-pools-section">
          <div class="pools-header">
            <h5>Funder Pools</h5>
            <p class="pools-instruction">Click to activate/deactivate individual pools</p>
          </div>
          
          <div class="pools-list">
            <% relationship.wholesale_funder.funder_pools.each do |pool| %>
              <% existing_pool_relationship = @existing_pool_relationships.find { |rel| rel.funder_pool_id == pool.id } %>
              <div class="pool-item"
                   data-pool-id="<%= pool.id %>"
                   data-pool-active="<%= existing_pool_relationship&.active? || false %>">
                
                <div class="pool-info">
                  <div class="pool-name"><%= pool.name %></div>
                  <div class="pool-details">
                    <span class="pool-amount"><%= pool.formatted_amount %></span>
                    <span class="pool-allocated">(<%= pool.formatted_allocated %> allocated)</span>
                    <span class="pool-rate"><%= pool.formatted_total_rate %></span>
                  </div>
                </div>
                
                <div class="pool-toggle" id="<%= dom_id(pool, :pool_toggle) %>">
                  <%= button_to toggle_pool_admin_lender_wholesale_funders_path(@lender), 
                      params: { funder_pool_id: pool.id },
                      method: :post,
                      remote: true,
                      class: "pool-toggle-btn #{existing_pool_relationship&.active? ? 'active' : 'inactive'}",
                      data: { 
                        turbo_confirm: "Are you sure you want to #{existing_pool_relationship&.active? ? 'deactivate' : 'activate'} #{pool.name}?"
                      } do %>
                    <%= existing_pool_relationship&.active? ? 'Active' : 'Inactive' %>
                  <% end %>
                </div>
                
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Available wholesale funders (not yet connected) -->
    <% @available_wholesale_funders.each do |wholesale_funder| %>
      <div class="wholesale-funder-card" 
           data-wholesale-funder-id="<%= wholesale_funder.id %>"
           data-lender-id="<%= @lender.id %>"
           data-wholesale-funder-interface-target="card"
           data-action="click->wholesale-funder-interface#toggleFunderSelection">
        
        <!-- Card Header -->
        <div class="card-header">
          <div class="card-title">
            <h4><%= wholesale_funder.name %></h4>
            <div class="selection-indicator">
              <span class="selection-icon">✓</span>
            </div>
          </div>
          <div class="card-status" data-status="unselected">
            <span class="status-text">Click to Select</span>
          </div>
        </div>

        <!-- Card Details -->
        <div class="card-details">
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Country</span>
              <span class="detail-value"><%= wholesale_funder.country %></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Currency</span>
              <span class="detail-value currency-badge currency-<%= wholesale_funder.currency.downcase %>">
                <%= wholesale_funder.currency_symbol %> <%= wholesale_funder.currency %>
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Pools</span>
              <span class="detail-value"><%= wholesale_funder.pools_count %> pools</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Total Capital</span>
              <span class="detail-value"><%= wholesale_funder.formatted_total_capital %></span>
            </div>
          </div>
        </div>

        <!-- Funder Pools (hidden initially) -->
        <div class="funder-pools-section display-none">
          <div class="pools-header">
            <h5>Funder Pools</h5>
            <p class="pools-instruction">Click to activate/deactivate individual pools</p>
          </div>
          
          <div class="pools-list">
            <% wholesale_funder.funder_pools.each do |pool| %>
              <% existing_pool_relationship = @existing_pool_relationships.find { |rel| rel.funder_pool_id == pool.id } %>
              <div class="pool-item" 
                   data-pool-id="<%= pool.id %>"
                   data-pool-active="<%= existing_pool_relationship&.active? || false %>">
                
                <div class="pool-info">
                  <div class="pool-name"><%= pool.name %></div>
                  <div class="pool-details">
                    <span class="pool-amount"><%= pool.formatted_amount %></span>
                    <span class="pool-allocated">(<%= pool.formatted_allocated %> allocated)</span>
                    <span class="pool-rate"><%= pool.formatted_total_rate %></span>
                  </div>
                </div>
                
                <div class="pool-toggle" id="<%= dom_id(pool, :pool_toggle) %>">
                  <%= button_to toggle_pool_admin_lender_wholesale_funders_path(@lender), 
                      params: { funder_pool_id: pool.id },
                      method: :post,
                      remote: true,
                      class: "pool-toggle-btn #{existing_pool_relationship&.active? ? 'active' : 'inactive'}",
                      data: { 
                        turbo_confirm: "Are you sure you want to #{existing_pool_relationship&.active? ? 'deactivate' : 'activate'} #{pool.name}?"
                      } do %>
                    <%= existing_pool_relationship&.active? ? 'Active' : 'Inactive' %>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Empty State -->
  <% if @available_wholesale_funders.empty? && @existing_relationships.empty? %>
    <div class="empty-state">
      <h4>No Wholesale Funders Available</h4>
      <p>All wholesale funders already have relationships with this lender, or none exist yet.</p>
      <%= link_to "Manage Wholesale Funders", admin_wholesale_funders_path, class: "admin-btn admin-btn-primary" %>
    </div>
  <% end %>
</div>


