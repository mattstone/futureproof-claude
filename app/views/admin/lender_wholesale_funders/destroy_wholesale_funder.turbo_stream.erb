<% if @success %>
  <!-- Update the existing relationships (left column) -->
  <%= turbo_stream.replace "existing-relationships" do %>
    <div id="existing-relationships">
      <% if @lender.lender_wholesale_funders.any? %>
        <div class="relationship-list">
          <% @lender.lender_wholesale_funders.includes(:wholesale_funder).each do |relationship| %>
            <div class="relationship-card" data-wholesale-funder-id="<%= relationship.wholesale_funder.id %>">
              <div class="relationship-header">
                <h5><%= relationship.wholesale_funder.name %></h5>
                <div class="relationship-actions">
                  <%= button_to relationship.status_display, toggle_active_admin_lender_wholesale_funder_path(@lender, relationship),
                                method: :patch, remote: true, class: "status-badge clickable-status-badge #{relationship.status_badge_class}",
                                role: "button", tabindex: "0", 
                                data: { confirm: "Are you sure you want to change the status of this wholesale funder relationship?" },
                                'aria-label': "Toggle wholesale funder status (currently #{relationship.status_display})",
                                form: { style: "display: inline;" } %>
                  <%= button_to "Remove", admin_lender_wholesale_funder_path(@lender, relationship),
                                method: :delete, class: "admin-btn admin-btn-danger admin-btn-sm",
                                remote: true, data: { confirm: "Are you sure you want to remove #{relationship.wholesale_funder.name}?" },
                                form: { style: "display: inline;" } %>
                </div>
              </div>
              <div class="relationship-details">
                <div class="detail-row">
                  <span class="detail-label">Country</span>
                  <span class="detail-value"><%= relationship.wholesale_funder.country %></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Currency</span>
                  <span class="detail-value"><%= relationship.wholesale_funder.currency_display %></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Created</span>
                  <span class="detail-value"><%= relationship.created_at.strftime("%b %d, %Y") %></span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="empty-state">
          <p>No wholesale funder relationships established.</p>
          <p>Use the "Add Wholesale Funder" button above to create your first relationship.</p>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Update the funder pools (right column) -->
  <%= turbo_stream.replace "pool-list-content" do %>
    <% if @lender.lender_funder_pools.any? %>
      <div class="pool-list">
        <% @lender.lender_funder_pools.includes(:funder_pool => :wholesale_funder).order(active: :desc).each do |pool_relationship| %>
          <% pool = pool_relationship.funder_pool %>
          <div class="pool-card">
            <div class="pool-header">
              <h5><%= pool.name %></h5>
              <div class="pool-actions">
                <%= button_to pool_relationship.status_display, toggle_active_admin_lender_funder_pool_path(@lender, pool_relationship),
                              method: :patch, remote: true, class: "status-badge clickable-status-badge #{pool_relationship.status_badge_class}",
                              role: "button", tabindex: "0",
                              data: { confirm: "Are you sure you want to change the status of this funder pool relationship?" },
                              'aria-label': "Toggle funder pool status (currently #{pool_relationship.status_display})",
                              form: { style: "display: inline;" } %>
                <%= button_to "Remove", admin_lender_funder_pool_path(@lender, pool_relationship),
                              method: :delete, class: "admin-btn admin-btn-danger admin-btn-sm",
                              remote: true, data: { confirm: "Are you sure?" },
                              form: { style: "display: inline;" } %>
              </div>
            </div>
            <div class="pool-details">
              <div class="detail-row">
                <span class="detail-label">Wholesale Funder</span>
                <span class="detail-value"><%= pool.wholesale_funder.name %></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value"><%= pool.formatted_amount %></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Available</span>
                <span class="detail-value"><%= pool.formatted_available %></span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Added</span>
                <span class="detail-value"><%= pool_relationship.created_at.strftime("%b %d, %Y") %></span>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="empty-state">
        <% if @lender.active_wholesale_funders.any? %>
          <p>No funder pools selected yet.</p>
          <%= link_to "Add First Funder Pool", new_admin_lender_funder_pool_path(@lender),
                      class: "admin-btn admin-btn-primary admin-btn-sm" %>
        <% else %>
          <p>Add wholesale funder relationships first to access their funder pools.</p>
        <% end %>
      </div>
    <% end %>
  <% end %>

  <!-- Success message will be shown by JavaScript notification -->
  <script>
    console.log('<%= @message %>');
    // Show a temporary success indicator
    if (window.showTemporarySuccess) {
      window.showTemporarySuccess('<%= @message %>');
    }
  </script>

<% else %>
  <!-- Show error message -->
  <%= turbo_stream.prepend "flash-messages" do %>
    <div class="alert alert-error">
      <%= @message %>
    </div>
  <% end %>
<% end %>

