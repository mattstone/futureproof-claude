<% content_for :page_title, @page_title %>
<% content_for :head do %>
  <script src="https://d3js.org/d3.v7.min.js"></script>
<% end %>

<!-- Calculator Header -->
<div class="calculator-header">
  <h1>Single mortgage model with Monte Carlo prices</h1>
  <p>Advanced financial modeling calculator for equity preservation mortgages</p>
</div>

<div id="calculator-app" data-controller="monte-carlo-calculator">

  <%= form_with url: calculate_admin_calculators_path, 
                local: false, data: { action: "submit->monte-carlo-calculator#calculate", "monte-carlo-calculator-target": "form" } do |f| %>
    
    <!-- Input Parameters -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Calculator Parameters</h2>
      </div>
      <div class="card-body p-4">
        <div class="row g-4 calculator-columns">
          <div class="col-lg-4">
            <div class="parameter-section">
              <h4 class="section-title border-bottom pb-2 mb-3">Borrower</h4>
              <div class="mb-3">
                <label class="form-label">House value $</label>
                <%= f.number_field "calculator[house_value]", class: "form-control", value: 1500000, min: 1000000, max: 3000000, step: 1000, placeholder: "1,500,000" %>
              </div>
              <div class="mb-3">
                <label class="form-label">Loan term Yrs</label>
                <%= f.select "calculator[loan_duration]", options_for_select([
                  ['15 years', 15],
                  ['20 years', 20],
                  ['25 years', 25],
                  ['30 years', 30]
                ], 30), {}, { class: "form-select", data: { action: "change->monte-carlo-calculator#validateTerms" } } %>
              </div>
              <div class="mb-3">
                <label class="form-label">Annuity duration Yrs</label>
                <%= f.select "calculator[annuity_duration]", options_for_select([
                  ['10 years', 10],
                  ['15 years', 15],
                  ['20 years', 20],
                  ['25 years', 25],
                  ['30 years', 30]
                ], 10), {}, { class: "form-select", data: { action: "change->monte-carlo-calculator#validateTerms" } } %>
              </div>
              <div class="mb-3">
                <label class="form-label">Loan type</label>
                <%= f.select "calculator[loan_type]", options_for_select([
                  ['Interest only', 'Interest only'],
                  ['Principal+Interest', 'Principal+Interest'],
                  ['Hybrid', 'Hybrid']
                ], 'Interest only'), {}, { class: "form-select" } %>
              </div>
              <div class="form-check mb-3">
                <%= f.check_box "calculator[principal_repayment]", class: "form-check-input" %>
                <%= f.label "calculator[principal_repayment]", "Principal repayment", class: "form-check-label" %>
              </div>
                <div class="mb-3">
                <label class="form-label">Loan-to-value %</label>
                <%= f.number_field "calculator[loan_to_value]", class: "form-control", value: 80, min: 10, max: 100, step: 5 %>
                </div>
                <div class="mb-3">
                <label class="form-label">Annual income $</label>
                <%= f.number_field "calculator[annual_income]", class: "form-control", value: 30000, min: 1000, max: 50000, step: 500, placeholder: "30,000" %>
                </div>
                <div class="mb-3">
                <label class="form-label">At Risk Capital fraction %</label>
                <%= f.number_field "calculator[at_risk_captital_fraction]", class: "form-control", value: 0, min: 0, max: 100, step: 0.01, placeholder: "0.00" %>
                </div>
              </div>
          </div>

          <div class="col-lg-4">
            <div class="parameter-section">
              <h4 class="section-title border-bottom pb-2 mb-3">Economic Assumptions</h4>
              <div class="mb-3">
              <label class="form-label">Equity return %</label>
              <%= f.number_field "calculator[equity_return]", class: "form-control", value: 9.75, min: 5, max: 15, step: 0.01, placeholder: "9.75" %>
              </div>
              <div class="mb-3">
              <label class="form-label">Volatility %</label>
              <%= f.number_field "calculator[volatility]", class: "form-control", value: 15, min: 0, max: 30, step: 0.01, placeholder: "15.00" %>
              </div>
              <div class="mb-3">
              <label class="form-label">Paths</label>
              <%= f.number_field "calculator[total_paths]", class: "form-control", value: 1000, min: 1, max: 20000, step: 1 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Random seed</label>
              <%= f.number_field "calculator[random_seed]", class: "form-control", value: 0, min: 0, max: 9999, step: 1 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Cash rate %</label>
              <%= f.number_field "calculator[cash_rate]", class: "form-control", value: 4.0, min: 0, max: 10, step: 0.01, placeholder: "4.00" %>
              </div>
            <div class="mb-3" data-monte-carlo-calculator-target="insurerProfitMargin">
              <label class="form-label">Insurer profit margin %</label>
              <%= f.number_field "calculator[insurer_profit_margin]", class: "form-control", value: 50, min: 0, max: 200, step: 0.01, placeholder: "50.00" %>
              </div>
              <div class="form-check mb-3">
              <%= f.check_box "calculator[hedged]", class: "form-check-input", data: { action: "change->monte-carlo-calculator#toggleHedged" } %>
              <%= f.label "calculator[hedged]", "Hedged", class: "form-check-label" %>
              </div>
            <div class="mb-3" data-monte-carlo-calculator-target="hedgingCost" style="display: none;">
              <label class="form-label">Hedging costs p.a. %</label>
              <%= f.number_field "calculator[hedging_cost_pa]", class: "form-control", value: 0.5, min: 0, max: 5, step: 0.05 %>
              </div>
            <div class="mb-3" data-monte-carlo-calculator-target="hedgingMaxLoss" style="display: none;">
              <label class="form-label">Max loss p.a. %</label>
              <%= f.number_field "calculator[hedging_max_loss]", class: "form-control", value: 10, min: 0, max: 50, step: 1 %>
              </div>
            <div class="mb-3" data-monte-carlo-calculator-target="hedgingCap" style="display: none;">
              <label class="form-label">Cap p.a. %</label>
              <%= f.number_field "calculator[hedging_cap]", class: "form-control", value: 20, min: 0, max: 50, step: 1 %>
              </div>
              </div>
          </div>

          <div class="col-lg-4">
            <div class="parameter-section">
              <h4 class="section-title border-bottom pb-2 mb-3">Loan</h4>
              <div class="mb-3">
              <label class="form-label">Wholesale lending margin %</label>
              <%= f.number_field "calculator[wholesale_lending_margin]", class: "form-control", value: 2, min: 0, max: 4, step: 0.01 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Additional loan margins %</label>
              <%= f.number_field "calculator[additional_loan_margins]", class: "form-control", value: 1.25, min: 0, max: 4, step: 0.01 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Holiday enter fraction %</label>
              <%= f.number_field "calculator[holiday_enter_fraction]", class: "form-control", value: 1.35, min: 0, max: 4, step: 0.01 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Holiday exit fraction %</label>
              <%= f.number_field "calculator[holiday_exit_fraction]", class: "form-control", value: 1.95, min: 0, max: 4, step: 0.01 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Subperform threshold quarters</label>
              <%= f.number_field "calculator[subperform_loan_threshold_quarters]", class: "form-control", value: 6, min: 0, max: 40, step: 1 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Deficit Repay Amount factor</label>
              <%= f.number_field "calculator[max_superpay_factor]", class: "form-control", value: 1.261, min: 0, max: 4, step: 0.001 %>
              </div>
              <div class="mb-3">
              <label class="form-label">Deficit Repay Start factor</label>
              <%= f.number_field "calculator[superpay_start_factor]", class: "form-control", value: 1.50, min: 1.0, max: 4, step: 0.01 %>
              </div>
              <div class="form-check mb-3">
              <%= f.check_box "calculator[enable_pool]", class: "form-check-input" %>
              <%= f.label "calculator[enable_pool]", "Enable shared pool", class: "form-check-label" %>
              </div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="margin-top: 2rem;"></div>
    
    <!-- Calculate Button Section -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="text-center">
          <div class="calculate-section" style="padding: 1rem;">
            <%= f.submit "Calculate", class: "btn btn-primary btn-lg", 
                         data: { "monte-carlo-calculator-target": "submitBtn" } %>
            <div class="spinner-border ms-3" role="status" style="display: none;" 
                 data-monte-carlo-calculator-target="spinner">
              <span class="visually-hidden">Calculating...</span>
            </div>
          </div>
          
          <!-- Loading Overlay -->
          <div class="loading-overlay" style="display: none;" data-monte-carlo-calculator-target="loadingOverlay">
            <div class="loading-content">
              <div class="elegant-spinner"></div>
              <p class="mt-3"><span style="font-size: 1.5em;">🎲</span> Monte Carlo simulation <span style="font-size: 1.5em;">🏁</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Results Section -->
  <div class="results-container" data-monte-carlo-calculator-target="results" style="display: none;">
    <div class="results-header">
      <h2>Calculation Results</h2>
    </div>
    <div class="results-content">
      <!-- Summary Statistics -->
      <div class="results-section">
        <div class="section-header">
          <h3>Key Metrics Summary</h3>
        </div>
        <div class="metrics-grid" data-monte-carlo-calculator-target="metricsGrid">
          <div class="metric-card">
            <div class="metric-value" data-monte-carlo-calculator-target="expectedValue">--</div>
            <div class="metric-label">Expected Return</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" data-monte-carlo-calculator-target="worstCase">--</div>
            <div class="metric-label">Worst Case (5%)</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" data-monte-carlo-calculator-target="medianValue">--</div>
            <div class="metric-label">Median Value</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" data-monte-carlo-calculator-target="bestCase">--</div>
            <div class="metric-label">Best Case (95%)</div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="results-section">
        <div class="section-header">
          <h3>Portfolio Performance Visualization</h3>
        </div>
        <div class="charts-grid">
          <!-- Portfolio Value Over Time -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>Portfolio Value Paths</h4>
              <p>Shows different outcome scenarios over time</p>
            </div>
            <div data-monte-carlo-calculator-target="portfolioChart" class="chart-canvas"></div>
          </div>
          
          <!-- Distribution Chart -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>Return Distribution</h4>
              <p>Frequency distribution of final outcomes</p>
            </div>
            <div data-monte-carlo-calculator-target="distributionChart" class="chart-canvas chart-canvas-small"></div>
          </div>
          
          <!-- S&P 500 Prices Chart -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>S&P 500 Price Simulations</h4>
              <p>Simulated S&P 500 price paths with mean</p>
            </div>
            <div data-monte-carlo-calculator-target="sp500Chart" class="chart-canvas"></div>
          </div>
          
          <!-- Loan and Interest Deficit Chart -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>Reinvestment Account, Loan & Interest Deficit</h4>
              <p>Mean path analysis of key financial components</p>
            </div>
            <div data-monte-carlo-calculator-target="loanDeficitChart" class="chart-canvas"></div>
          </div>
          
          <!-- Units Analysis Chart -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>Hedged, Insured & Pooled Units</h4>
              <p>Mean path unit allocation analysis</p>
            </div>
            <div data-monte-carlo-calculator-target="unitsChart" class="chart-canvas"></div>
          </div>
          
          <!-- Cumulative Values Chart -->
          <div class="chart-container">
            <div class="chart-header">
              <h4>Cumulative Financial Flows</h4>
              <p>Annuity income, interest accrued/paid, loan, surplus, S&P units</p>
            </div>
            <div data-monte-carlo-calculator-target="cumulativeChart" class="chart-canvas"></div>
          </div>
        </div>
      </div>

      <!-- Risk Metrics -->
      <div class="results-section">
        <div class="section-header">
          <h3>Risk Analysis</h3>
        </div>
        <div class="risk-analysis" data-monte-carlo-calculator-target="riskAnalysis">
          <div class="risk-grid">
            <div class="risk-metric">
              <span class="risk-label">Value at Risk (5%):</span>
              <span class="risk-value" data-monte-carlo-calculator-target="varValue">--</span>
            </div>
            <div class="risk-metric">
              <span class="risk-label">Probability of Loss:</span>
              <span class="risk-value" data-monte-carlo-calculator-target="lossProb">--</span>
            </div>
            <div class="risk-metric">
              <span class="risk-label">Volatility:</span>
              <span class="risk-value" data-monte-carlo-calculator-target="volatilityMetric">--</span>
            </div>
            <div class="risk-metric">
              <span class="risk-label">Sharpe Ratio:</span>
              <span class="risk-value" data-monte-carlo-calculator-target="sharpeRatio">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Tables -->
      <div class="results-section">
        <div class="section-header">
          <h3>Detailed Analysis Tables</h3>
        </div>
        
        <!-- Main Output Table -->
        <div class="table-section">
          <h4>Main Outputs</h4>
          <div class="table-container">
            <table class="results-table" data-monte-carlo-calculator-target="mainOutputTable">
              <thead>
                <tr>
                  <th>Quantity</th>
                  <th>Formula</th>
                  <th>Expected value</th>
                  <th>Worse path value</th>
                  <th>Bad path value</th>
                  <th>Median path value</th>
                  <th>Good path value</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7" style="text-align: center; color: #6b7280;">No data available</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Path Table -->
        <div class="table-section">
          <div class="table-header-with-controls">
            <h4>Path Analysis</h4>
            <div class="path-controls">
              <label for="pathTableType">Path output:</label>
              <%= select_tag :path_table_type, 
                    options_for_select([
                      ['Mean', 'Mean'],
                      ['Median', 'Median'],
                      ['2% percentile', '2% percentile'],
                      ['25% percentile', '25% percentile'],
                      ['75% percentile', '75% percentile']
                    ], 'Mean'),
                    { class: "path-selector", 
                      data: { action: "change->monte-carlo-calculator#updatePathTable" } } %>
            </div>
          </div>
          <div class="table-container">
            <table class="results-table" data-monte-carlo-calculator-target="pathTable">
              <thead>
                <tr>
                  <th>Period</th>
                  <th>SP500</th>
                  <th>Interest</th>
                  <th>Loan size</th>
                  <th>Units</th>
                  <th>Reinvestment</th>
                  <th>InterestDeficit</th>
                  <th>CapitalDeficit</th>
                  <th>Surplus</th>
                  <th>FunderEarned</th>
                  <th>AnnuityIncome</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="11" style="text-align: center; color: #6b7280;">No data available</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>