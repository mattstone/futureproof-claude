<% content_for :title, "Email Workflows" %>
<% content_for :breadcrumb, "Email Workflows" %>

<div class="workflow-manager">
  <!-- Tabs Navigation -->
  <div class="tab-navigation mb-6">
    <div class="tab-buttons">
      <button class="tab-button active" data-tab="workflows">
        <i class="fas fa-project-diagram"></i> Workflows
      </button>
      <button class="tab-button" data-tab="templates">
        <i class="fas fa-envelope"></i> Email Templates
      </button>
      <button class="tab-button" data-tab="library">
        <i class="fas fa-layer-group"></i> Template Library
      </button>
    </div>
  </div>

  <!-- Workflows Tab -->
  <div class="tab-content active" id="workflows-tab">
    <!-- Header with stats and actions -->
    <div class="workflow-header">
      <div class="workflow-header-content">
        <div class="workflow-stats-grid">
          <div class="stat-card">
            <div class="stat-number"><%= @workflow_stats[:total] %></div>
            <div class="stat-label">Total Workflows</div>
          </div>
          <div class="stat-card">
            <div class="stat-number active"><%= @workflow_stats[:active] %></div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-card">
            <div class="stat-number inactive"><%= @workflow_stats[:inactive] %></div>
            <div class="stat-label">Inactive</div>
          </div>
        </div>
        
        <div class="workflow-actions">
          <%= link_to new_admin_email_workflow_path, class: "btn-primary" do %>
            <i class="fas fa-plus"></i> New Workflow
          <% end %>
        </div>
      </div>
    </div>

  <!-- Filters -->
  <div class="workflow-filters mb-6">
    <%= form_with url: admin_email_workflows_path, method: :get, local: true, 
                  class: "filter-form flex items-center space-x-4" do |form| %>
      <div class="filter-group">
        <%= form.select :trigger_type, 
                        options_for_select([['All Triggers', '']] + 
                        @trigger_types.map { |type| [type.humanize, type] }, 
                        params[:trigger_type]), 
                        {}, { class: "form-select" } %>
      </div>
      
      <div class="filter-group">
        <%= form.select :active, 
                        options_for_select([['All Status', ''], ['Active', 'true'], ['Inactive', 'false']], 
                        params[:active]), 
                        {}, { class: "form-select" } %>
      </div>
      
      <div class="filter-actions">
        <%= form.submit "Filter", class: "btn-secondary" %>
        <%= link_to "Clear", admin_email_workflows_path, class: "btn-link" %>
      </div>
    <% end %>
  </div>

  <!-- Workflows Grid -->
  <div class="workflows-grid">
    <% if @workflows.present? %>
      <% @workflows.each do |workflow| %>
        <div class="workflow-card <%= 'inactive' unless workflow.active? %>">
          <div class="workflow-header">
            <div class="workflow-status">
              <span class="status-badge <%= workflow.active? ? 'active' : 'inactive' %>">
                <%= workflow.active? ? 'Active' : 'Inactive' %>
              </span>
              <span class="trigger-badge">
                <%= workflow.trigger_type.humanize %>
              </span>
            </div>
            
            <div class="workflow-actions-dropdown">
              <div class="dropdown">
                <button class="dropdown-toggle" data-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu">
                  <%= link_to admin_email_workflow_path(workflow), class: "dropdown-item" do %>
                    <i class="fas fa-eye"></i> View Details
                  <% end %>
                  <%= link_to edit_admin_email_workflow_path(workflow), class: "dropdown-item" do %>
                    <i class="fas fa-edit"></i> Edit
                  <% end %>
                  <%= link_to preview_admin_email_workflow_path(workflow), class: "dropdown-item" do %>
                    <i class="fas fa-search"></i> Preview
                  <% end %>
                  <%= link_to duplicate_admin_email_workflow_path(workflow), 
                             method: :post, class: "dropdown-item" do %>
                    <i class="fas fa-copy"></i> Duplicate
                  <% end %>
                  <div class="dropdown-divider"></div>
                  <%= link_to toggle_active_admin_email_workflow_path(workflow), 
                             method: :patch, class: "dropdown-item" do %>
                    <i class="fas fa-<%= workflow.active? ? 'pause' : 'play' %>"></i> 
                    <%= workflow.active? ? 'Deactivate' : 'Activate' %>
                  <% end %>
                  <%= link_to admin_email_workflow_path(workflow), 
                             method: :delete, 
                             class: "dropdown-item text-red-600",
                             data: { 
                               confirm: "Are you sure? This will permanently delete the workflow '#{workflow.name}' and cannot be undone." 
                             } do %>
                    <i class="fas fa-trash"></i> Delete
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="workflow-content">
            <h3 class="workflow-name">
              <%= link_to workflow.name, admin_email_workflow_path(workflow), 
                         class: "workflow-link" %>
            </h3>
            
            <% if workflow.description.present? %>
              <p class="workflow-description">
                <%= truncate(workflow.description, length: 120) %>
              </p>
            <% end %>
            
            <div class="workflow-meta">
              <div class="meta-item">
                <i class="fas fa-list"></i>
                <span><%= pluralize(workflow.workflow_steps.count, 'step') %></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-play-circle"></i>
                <span><%= pluralize(workflow.workflow_executions.count, 'execution') %></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-user"></i>
                <span>By <%= workflow.created_by.display_name %></span>
              </div>
              <div class="meta-item">
                <i class="fas fa-clock"></i>
                <span><%= time_ago_in_words(workflow.created_at) %> ago</span>
              </div>
            </div>
            
            <!-- Quick execution stats -->
            <% if workflow.workflow_executions.any? %>
              <div class="workflow-stats">
                <% executions = workflow.workflow_executions %>
                <% success_rate = executions.finished.any? ? 
                   (executions.where(status: 'completed').count.to_f / executions.finished.count * 100).round(1) : 0 %>
                <div class="stat-mini">
                  <span class="stat-label">Success Rate</span>
                  <span class="stat-value <%= success_rate > 80 ? 'good' : success_rate > 50 ? 'warning' : 'poor' %>">
                    <%= success_rate %>%
                  </span>
                </div>
                <div class="stat-mini">
                  <span class="stat-label">Last Run</span>
                  <span class="stat-value">
                    <%= time_ago_in_words(executions.order(:created_at).last.created_at) %> ago
                  </span>
                </div>
              </div>
            <% end %>
          </div>
          
          <!-- Workflow Steps Preview -->
          <div class="workflow-steps-preview">
            <div class="steps-list">
              <% workflow.workflow_steps.ordered.limit(3).each_with_index do |step, index| %>
                <div class="step-preview">
                  <div class="step-icon">
                    <%= render 'admin/email_workflows/step_icon', step: step %>
                  </div>
                  <div class="step-label">
                    <%= step.name.present? ? step.name : step.step_type.humanize %>
                  </div>
                </div>
                <% unless index == 2 || step == workflow.workflow_steps.ordered.last %>
                  <div class="step-connector">â†’</div>
                <% end %>
              <% end %>
              <% if workflow.workflow_steps.count > 3 %>
                <div class="steps-more">
                  +<%= workflow.workflow_steps.count - 3 %> more
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-project-diagram"></i>
        </div>
        <h3>No Email Workflows</h3>
        <p>Create your first workflow to automate customer communications throughout their lifecycle.</p>
        <%= link_to new_admin_email_workflow_path, class: "btn-primary" do %>
          <i class="fas fa-plus"></i> Create Your First Workflow
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Trigger Type Statistics -->
  <% if @workflow_stats[:by_trigger].any? %>
    <div class="trigger-stats mt-8">
      <h4 class="section-title">Workflows by Trigger Type</h4>
      <div class="trigger-grid">
        <% @workflow_stats[:by_trigger].each do |trigger, count| %>
          <div class="trigger-stat-card">
            <div class="trigger-count"><%= count %></div>
            <div class="trigger-name"><%= trigger.humanize %></div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  </div>

  <!-- Email Templates Tab -->
  <div class="tab-content" id="templates-tab">
    <div class="templates-header mb-6">
      <div class="flex items-center justify-between">
        <h3>Email Templates</h3>
        <%= link_to new_admin_email_template_path, class: "btn-primary" do %>
          <i class="fas fa-plus"></i> New Template
        <% end %>
      </div>
    </div>
    
    <div class="templates-loading">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading templates...
      </div>
    </div>
  </div>

  <!-- Template Library Tab -->
  <div class="tab-content" id="library-tab">
    <div class="library-header mb-6">
      <h3>Workflow Template Library</h3>
      <p class="text-gray-600">Pre-built workflows for common customer lifecycle scenarios</p>
    </div>
    
    <div class="library-loading">
      <div class="loading-spinner">
        <i class="fas fa-spinner fa-spin"></i> Loading library...
      </div>
    </div>
  </div>
</div>

<style>
.workflow-manager {
  padding: 0;
}

/* Tab Navigation */
.tab-navigation {
  border-bottom: 1px solid #e5e7eb;
  background: white;
  border-radius: 8px 8px 0 0;
}

.tab-buttons {
  display: flex;
  gap: 0;
}

.tab-button {
  padding: 12px 24px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  color: #6b7280;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab-button:hover {
  color: #374151;
  background: #f9fafb;
}

.tab-button.active {
  color: #3b82f6;
  border-bottom-color: #3b82f6;
  background: #f8fafc;
}

/* Tab Content */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* Templates Tab */
.templates-header h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
}

.templates-loading,
.library-loading {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 200px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.loading-spinner {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #6b7280;
  font-size: 0.875rem;
}

/* Library Tab */
.library-header h3 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 4px;
}

.workflow-header {
  background: white;
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 24px;
  border: 1px solid #e5e7eb;
}

.workflow-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 24px;
}

.workflow-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  max-width: 600px;
  flex: 1;
}

.workflow-actions {
  flex-shrink: 0;
}

.stat-card {
  text-align: center;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: #111827;
  margin-bottom: 4px;
}

.stat-number.active { color: #10b981; }
.stat-number.inactive { color: #6b7280; }

.stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.workflow-filters {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.filter-form {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.workflows-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 24px;
}

.workflow-card {
  background: white;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  overflow: hidden;
  transition: all 0.2s ease;
}

.workflow-card:hover {
  border-color: #d1d5db;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  transform: translateY(-1px);
}

.workflow-card.inactive {
  opacity: 0.7;
}

.workflow-card .workflow-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px 0;
  background: none;
  border: none;
  margin: 0;
}

.workflow-status {
  display: flex;
  gap: 8px;
  align-items: center;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.status-badge.active {
  background: #d1fae5;
  color: #065f46;
}

.status-badge.inactive {
  background: #f3f4f6;
  color: #374151;
}

.trigger-badge {
  padding: 4px 8px;
  background: #eff6ff;
  color: #1d4ed8;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}

.workflow-content {
  padding: 0 20px 16px;
}

.workflow-name {
  font-size: 1.25rem;
  font-weight: 600;
  margin: 12px 0 8px;
}

.workflow-link {
  color: #111827;
  text-decoration: none;
}

.workflow-link:hover {
  color: #3b82f6;
}

.workflow-description {
  color: #6b7280;
  margin-bottom: 16px;
  line-height: 1.5;
}

.workflow-meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-bottom: 16px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #6b7280;
  font-size: 0.875rem;
}

.meta-item i {
  width: 12px;
  color: #9ca3af;
}

.workflow-stats {
  display: flex;
  gap: 16px;
  margin-bottom: 12px;
  padding-top: 12px;
  border-top: 1px solid #f3f4f6;
}

.stat-mini {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.stat-mini .stat-label {
  font-size: 0.75rem;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.stat-mini .stat-value {
  font-weight: 600;
  font-size: 0.875rem;
}

.stat-mini .stat-value.good { color: #10b981; }
.stat-mini .stat-value.warning { color: #f59e0b; }
.stat-mini .stat-value.poor { color: #ef4444; }

.workflow-steps-preview {
  padding: 16px 20px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.steps-list {
  display: flex;
  align-items: center;
  gap: 8px;
  overflow-x: auto;
}

.step-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  min-width: 60px;
}

.step-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
}

.step-label {
  font-size: 0.75rem;
  color: #6b7280;
  text-align: center;
  word-break: break-word;
}

.step-connector {
  color: #d1d5db;
  font-weight: bold;
}

.steps-more {
  color: #9ca3af;
  font-size: 0.75rem;
  white-space: nowrap;
}

.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 64px 32px;
  background: white;
  border-radius: 12px;
  border: 2px dashed #d1d5db;
}

.empty-icon {
  font-size: 3rem;
  color: #d1d5db;
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 1.5rem;
  color: #111827;
  margin-bottom: 8px;
}

.empty-state p {
  color: #6b7280;
  margin-bottom: 24px;
}

.trigger-stats {
  background: white;
  padding: 24px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 16px;
}

.trigger-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.trigger-stat-card {
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #e5e7eb;
}

.trigger-count {
  font-size: 1.5rem;
  font-weight: bold;
  color: #3b82f6;
  margin-bottom: 4px;
}

.trigger-name {
  color: #6b7280;
  font-size: 0.875rem;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  background: none;
  border: none;
  padding: 4px;
  cursor: pointer;
  color: #6b7280;
  border-radius: 4px;
}

.dropdown-toggle:hover {
  background: #f3f4f6;
  color: #374151;
}

.dropdown-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  z-index: 10;
  min-width: 160px;
}

.dropdown:hover .dropdown-menu {
  display: block;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  color: #374151;
  text-decoration: none;
  font-size: 0.875rem;
}

.dropdown-item:hover {
  background: #f3f4f6;
}

.dropdown-divider {
  height: 1px;
  background: #e5e7eb;
  margin: 4px 0;
}

@media (max-width: 768px) {
  .workflows-grid {
    grid-template-columns: 1fr;
  }
  
  .workflow-meta {
    grid-template-columns: 1fr;
  }
  
  .workflow-header-content {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }
  
  .workflow-stats-grid {
    grid-template-columns: repeat(3, 1fr);
    max-width: none;
  }
  
  .workflow-actions {
    align-self: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching functionality
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const targetTab = button.getAttribute('data-tab');
      
      // Remove active class from all buttons and contents
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked button and corresponding content
      button.classList.add('active');
      document.getElementById(`${targetTab}-tab`).classList.add('active');
      
      // Load content based on tab
      if (targetTab === 'templates') {
        loadEmailTemplates();
      } else if (targetTab === 'library') {
        loadTemplateLibrary();
      }
    });
  });
  
  // Load email templates via AJAX
  function loadEmailTemplates() {
    const templatesContainer = document.getElementById('templates-tab');
    const loadingDiv = templatesContainer.querySelector('.templates-loading');
    
    if (templatesContainer.dataset.loaded === 'true') return;
    
    fetch('/admin/email_templates', {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      // Extract the main content from the response
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const mainContent = doc.querySelector('.admin-content') || doc.body;
      
      // Replace loading content with actual templates
      loadingDiv.innerHTML = mainContent.innerHTML;
      templatesContainer.dataset.loaded = 'true';
    })
    .catch(error => {
      loadingDiv.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Failed to load email templates</p>
          <button onclick="loadEmailTemplates()" class="btn-secondary">Retry</button>
        </div>
      `;
      console.error('Error loading email templates:', error);
    });
  }
  
  // Load template library via AJAX
  function loadTemplateLibrary() {
    const libraryContainer = document.getElementById('library-tab');
    const loadingDiv = libraryContainer.querySelector('.library-loading');
    
    if (libraryContainer.dataset.loaded === 'true') return;
    
    fetch('/admin/email_workflows/templates', {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      // Extract the main content from the response
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const mainContent = doc.querySelector('.admin-content') || doc.body;
      
      // Replace loading content with actual library
      loadingDiv.innerHTML = mainContent.innerHTML;
      libraryContainer.dataset.loaded = 'true';
    })
    .catch(error => {
      loadingDiv.innerHTML = `
        <div class="error-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Failed to load template library</p>
          <button onclick="loadTemplateLibrary()" class="btn-secondary">Retry</button>
        </div>
      `;
      console.error('Error loading template library:', error);
    });
  }
  
  // Make functions global so they can be called from error buttons
  window.loadEmailTemplates = loadEmailTemplates;
  window.loadTemplateLibrary = loadTemplateLibrary;
});
</script>