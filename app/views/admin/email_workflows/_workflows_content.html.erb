<%= turbo_frame_tag "workflows-content" do %>
  <div>
    <% if workflows.present? %>
      
      <!-- Table View Only -->
      <div class="workflows-table-container">
        <table class="workflows-table">
          <thead>
            <tr>
              <th class="workflow-name-col">Workflow Name</th>
              <th class="status-col">Status</th>
              <th class="trigger-col">Trigger</th>
              <th class="steps-col">Steps</th>
              <th class="executions-col">Runs</th>
              <th class="success-col">Success</th>
              <th class="modified-col">Modified</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% workflows.each do |workflow| %>
              <% executions = workflow.workflow_executions %>
              <% success_rate = executions.finished.any? ? 
                 (executions.where(status: 'completed').count.to_f / executions.finished.count * 100).round(1) : 0 %>
              <tr class="workflow-row <%= 'inactive-row' unless workflow.active? %>" data-workflow-id="<%= workflow.id %>">
                <td class="workflow-name-cell">
                  <div class="workflow-name-content">
                    <%= link_to admin_email_workflow_path(workflow), class: "workflow-title-link", data: { turbo_frame: "_top" } do %>
                      <strong><%= workflow.name %></strong>
                    <% end %>
                    <% if workflow.description.present? %>
                      <div class="workflow-description-brief">
                        <%= truncate(workflow.description, length: 60) %>
                      </div>
                    <% end %>
                  </div>
                </td>
                <td class="status-cell">
                  <span class="status-badge <%= workflow.active? ? 'active' : 'inactive' %>">
                    <%= workflow.active? ? 'Active' : 'Inactive' %>
                  </span>
                </td>
                <td class="trigger-cell">
                  <span class="trigger-tag">
                    <%= workflow.trigger_type.humanize %>
                  </span>
                </td>
                <td class="steps-cell">
                  <span class="steps-count">
                    <i class="fas fa-list-ol"></i>
                    <%= workflow.workflow_steps.count %>
                  </span>
                </td>
                <td class="executions-cell">
                  <span class="executions-count">
                    <%= executions.count %>
                  </span>
                </td>
                <td class="success-cell">
                  <% if executions.any? %>
                    <span class="success-rate <%= success_rate > 80 ? 'good' : success_rate > 50 ? 'warning' : 'poor' %>">
                      <%= success_rate %>%
                    </span>
                  <% else %>
                    <span class="no-data">â€”</span>
                  <% end %>
                </td>
                <td class="modified-cell">
                  <span class="modified-time">
                    <%= time_ago_in_words(workflow.updated_at) %>
                  </span>
                </td>
                <td class="actions-cell">
                  <div class="workflow-actions-dropdown">
                    <div class="dropdown-css">
                      <button class="dropdown-toggle-compact" type="button">
                        <i class="fas fa-cog"></i> Actions
                      </button>
                      <div class="dropdown-menu-css">
                        <%= link_to admin_email_workflow_path(workflow), class: "dropdown-item-css", data: { turbo_frame: "_top" } do %>
                          <i class="fas fa-eye"></i> View
                        <% end %>
                        <%= link_to edit_admin_email_workflow_path(workflow), class: "dropdown-item-css", data: { turbo_frame: "_top" } do %>
                          <i class="fas fa-edit"></i> Edit
                        <% end %>
                        <%= link_to preview_admin_email_workflow_path(workflow), class: "dropdown-item-css", data: { turbo_frame: "_top" } do %>
                          <i class="fas fa-search"></i> Preview
                        <% end %>
                        <%= link_to duplicate_admin_email_workflow_path(workflow), 
                                   method: :post, class: "dropdown-item-css", data: { turbo_frame: "_top" } do %>
                          <i class="fas fa-copy"></i> Duplicate
                        <% end %>
                        <div class="dropdown-divider-css"></div>
                        <%= link_to toggle_active_admin_email_workflow_path(workflow), 
                                   method: :patch, class: "dropdown-item-css", data: { turbo_frame: "_top" } do %>
                          <i class="fas fa-<%= workflow.active? ? 'pause' : 'play' %>"></i> 
                          <%= workflow.active? ? 'Deactivate' : 'Activate' %>
                        <% end %>
                        <%= link_to admin_email_workflow_path(workflow), 
                                   method: :delete, 
                                   class: "dropdown-item-css text-red-600",
                                   data: { 
                                     turbo_frame: "_top",
                                     confirm: "Are you sure? This will permanently delete the workflow '#{workflow.name}' and cannot be undone." 
                                   } do %>
                          <i class="fas fa-trash"></i> Delete
                        <% end %>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-project-diagram"></i>
        </div>
        <h3>No Email Workflows</h3>
        <p>Create your first workflow to automate customer communications throughout their lifecycle.</p>
        <%= link_to new_admin_email_workflow_path, class: "btn-primary" do %>
          <i class="fas fa-plus"></i> Create Your First Workflow
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Trigger Type Statistics -->
  <% if workflow_stats[:by_trigger].any? %>
    <div class="trigger-stats mt-8">
      <h4 class="section-title">Workflows by Trigger Type</h4>
      <div class="trigger-grid">
        <% workflow_stats[:by_trigger].each do |trigger, count| %>
          <div class="trigger-stat-card">
            <div class="trigger-count"><%= count %></div>
            <div class="trigger-name"><%= trigger.humanize %></div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>