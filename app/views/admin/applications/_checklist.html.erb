<% if @application.status_submitted? %>
  <!-- Submitted Application - Show Advance to Processing Button -->
  <div class="admin-card checklist-card">
    <div class="checklist-header">
      <h3>ğŸ“‹ Application Submitted</h3>
      <div class="checklist-timestamp">
        Submitted <%= time_ago_in_words(@application.updated_at) %> ago
      </div>
    </div>
    <p class="section-subtitle">This application is ready to be processed. Creating a processing checklist will automatically change the status to "Processing".</p>
    
    <div class="checklist-action">
      <%= button_to advance_to_processing_admin_application_path(@application), 
          method: :patch, 
          class: "admin-btn admin-btn-primary checklist-start-btn",
          data: { confirm: "This will create a processing checklist and change the status to 'Processing'. Continue?" } do %>
        <span class="btn-icon">ğŸš€</span>
        Start Processing
      <% end %>
    </div>
  </div>
<% elsif @application.status_processing? %>
  <!-- Processing Application - Show Checklist -->
  <div class="admin-card checklist-card" data-controller="checklist">
    <div class="checklist-header">
      <h3>âš™ï¸ Processing Checklist</h3>
      <div class="checklist-timestamp">
        Processing since <%= time_ago_in_words(@application.updated_at) %> ago
      </div>
    </div>
    <div class="checklist-progress-info">
      <div class="info-box">
        Complete all items below to approve the application for acceptance
      </div>
    </div>
    
    <div class="checklist-progress <%= 'completed' if @application.checklist_completed? %>">
      <div class="progress-bar">
        <div class="progress-fill" 
             data-progress="<%= @application.checklist_completion_percentage %>"
             style="width: <%= @application.checklist_completion_percentage %>%"></div>
      </div>
      <div class="progress-text">
        <span class="progress-stats">
          <%= @application.application_checklists.completed.count %> of <%= @application.application_checklists.count %> completed
        </span>
        <span class="progress-percentage">
          <%= @application.checklist_completion_percentage %>%
        </span>
      </div>
    </div>
    
    <div class="checklist-items">
      <% @application.application_checklists.ordered.each_with_index do |item, index| %>
        <div class="checklist-item <%= 'completed' if item.completed? %>" data-checklist-item="<%= item.id %>">
          
          <% editable_param = local_assigns.fetch(:editable, local_assigns.fetch('editable', true)) %>
          <% if editable_param %>
            <%= form_with url: update_checklist_item_admin_application_path(@application, checklist_item_id: item.id), 
                method: :patch, local: false, class: "checklist-form", 
                data: { checklist_target: "form", action: "submit->checklist#submit" } do |form| %>
              <div class="checkbox-wrapper">
                <%= check_box_tag :completed, true, item.completed?, 
                    id: "checklist_item_#{item.id}",
                    class: "checklist-checkbox",
                    data: { action: "change->checklist#change" } %>
                <%= hidden_field_tag :redirect_to, request.fullpath %>
              </div>
            <% end %>
          <% else %>
            <div class="checkbox-wrapper">
              <input type="checkbox" <%= 'checked' if item.completed? %> disabled class="checklist-checkbox readonly">
            </div>
          <% end %>
          
          <div class="checklist-content">
            <label for="checklist_item_<%= item.id %>" class="checklist-label">
              <%= item.name %>
            </label>
            <% if item.completed? %>
              <div class="checklist-meta">
                <span class="meta-icon">ğŸ‘¤</span>
                Completed by <strong><%= item.completed_by_name %></strong>
                <br>
                <span class="meta-icon">ğŸ•</span>
                <%= item.completed_at.strftime("%B %d, %Y at %I:%M %p") %>
                <span class="time-ago">(<%= time_ago_in_words(item.completed_at) %> ago)</span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    
    <% if @application.checklist_completed? %>
      <div class="checklist-complete">
        <div class="alert alert-success">
          <div class="alert-content">
            <span class="alert-icon">ğŸ‰</span>
            <div class="alert-text">
              <strong>All checklist items completed!</strong>
              <p>This application has met all processing requirements and is ready for final approval. You can now change the status to "Accepted" in the application details.</p>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% elsif @application.status_rejected? %>
  <!-- Rejected Application - Show Checklist for Record Keeping -->
  <div class="admin-card checklist-card rejected">
    <div class="checklist-header">
      <h3>âŒ Application Rejected</h3>
      <div class="checklist-timestamp">
        Rejected <%= time_ago_in_words(@application.updated_at) %> ago
      </div>
    </div>
    <p class="section-subtitle">Processing checklist maintained for audit trail</p>
    
    <% if @application.application_checklists.any? %>
      <div class="checklist-progress rejected">
        <div class="progress-bar">
          <div class="progress-fill rejected" 
               style="width: <%= @application.checklist_completion_percentage %>%"></div>
        </div>
        <div class="progress-text">
          <span class="progress-stats">
            <%= @application.application_checklists.completed.count %> of <%= @application.application_checklists.count %> completed when rejected
          </span>
        </div>
      </div>
      
      <div class="checklist-items">
        <% @application.application_checklists.ordered.each_with_index do |item, index| %>
          <div class="checklist-item <%= 'completed' if item.completed? %> readonly">
            
            <div class="checkbox-wrapper">
              <input type="checkbox" <%= 'checked' if item.completed? %> disabled class="checklist-checkbox readonly">
            </div>
            
            <div class="checklist-content">
              <div class="checklist-label">
                <%= item.name %>
              </div>
              <% if item.completed? %>
                <div class="checklist-meta">
                  <span class="meta-icon">ğŸ‘¤</span>
                  Completed by <strong><%= item.completed_by_name %></strong>
                  <br>
                  <span class="meta-icon">ğŸ•</span>
                  <%= item.completed_at.strftime("%B %d, %Y at %I:%M %p") %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      
      <div class="rejection-info">
        <div class="alert alert-warning">
          <div class="alert-content">
            <span class="alert-icon">âš ï¸</span>
            <div class="alert-text">
              <strong>Application was rejected during processing</strong>
              <% if @application.rejected_reason.present? %>
                <p><strong>Reason:</strong> <%= @application.rejected_reason %></p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="no-checklist-info">
        <div class="info-box">
          This application was rejected before a processing checklist was created.
        </div>
      </div>
    <% end %>
  </div>
<% elsif @application.status_accepted? %>
  <!-- Accepted Application - Show Completed Checklist -->
  <div class="admin-card checklist-card accepted">
    <div class="checklist-header">
      <h3>âœ… Application Approved</h3>
      <div class="checklist-timestamp">
        Approved <%= time_ago_in_words(@application.updated_at) %> ago
      </div>
    </div>
    <p class="section-subtitle">All processing requirements completed successfully</p>
    
    <div class="checklist-progress completed">
      <div class="progress-bar">
        <div class="progress-fill" data-progress="100" style="width: 100%"></div>
      </div>
      <div class="progress-text">
        <span class="progress-stats">
          <%= @application.application_checklists.count %> of <%= @application.application_checklists.count %> completed
        </span>
        <span class="progress-percentage">100%</span>
      </div>
    </div>
    
    <div class="checklist-items">
      <% @application.application_checklists.ordered.each_with_index do |item, index| %>
        <div class="checklist-item completed readonly">
          
          <div class="checkbox-wrapper">
            <input type="checkbox" checked disabled class="checklist-checkbox readonly">
          </div>
          
          <div class="checklist-content">
            <div class="checklist-label">
              <%= item.name %>
            </div>
            <div class="checklist-meta">
              <span class="meta-icon">ğŸ‘¤</span>
              Completed by <strong><%= item.completed_by_name %></strong>
              <br>
              <span class="meta-icon">ğŸ•</span>
              <%= item.completed_at.strftime("%B %d, %Y at %I:%M %p") %>
              <span class="time-ago">(<%= time_ago_in_words(item.completed_at) %> ago)</span>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    
    <div class="checklist-complete">
      <div class="alert alert-success">
        <div class="alert-content">
          <span class="alert-icon">ğŸŠ</span>
          <div class="alert-text">
            <strong>Application Approved Successfully!</strong>
            <p>All processing requirements have been completed and verified. The application has been officially accepted.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>