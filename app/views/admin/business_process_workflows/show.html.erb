<% content_for :title, @workflow.name %>

<div class="site-mb-6">
  <div class="site-flex-between">
    <div>
      <nav class="site-flex" aria-label="Breadcrumb">
        <ol class="site-flex site-space-x-4">
          <li>
            <a href="<%= admin_business_process_workflows_path %>" class="site-text-gray-500 admin-breadcrumb-link">
              Business Process Workflows
            </a>
          </li>
          <li class="site-flex">
            <svg class="site-flex-shrink-0 site-h-5 site-w-5 site-text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
            <span class="site-ml-4 site-text-sm site-font-medium site-text-gray-900"><%= @workflow.name %></span>
          </li>
        </ol>
      </nav>
      <h1 class="site-text-2xl site-font-bold site-text-gray-900 site-mt-2"><%= @workflow.name %></h1>
      <p class="site-text-gray-600 site-mt-1"><%= @workflow.description %></p>
    </div>
    
    <div class="site-flex site-space-x-3">
      <span class="site-inline-flex site-px-3 site-py-1 site-rounded-full site-text-sm site-font-medium <%= @workflow.active? ? 'site-bg-green-100 site-text-green-800' : 'site-bg-gray-100 site-text-gray-800' %>">
        <%= @workflow.active? ? 'Active' : 'Inactive' %>
      </span>
      <a href="<%= edit_admin_business_process_workflow_path(@workflow) %>" class="site-bg-blue-600 admin-btn-hover site-text-white site-px-4 site-py-2 site-rounded-lg">
        Edit Workflow
      </a>
    </div>
  </div>
</div>

<!-- Workflow Overview -->
<div class="site-grid-3 site-grid-gap-lg site-mb-8">
  <div class="site-bg-white site-p-6 site-rounded-lg site-shadow site-border">
    <div class="site-flex">
      <div class="site-flex-shrink-0">
        <div class="site-w-8 site-h-8 site-bg-blue-500 site-rounded-lg site-flex-center">
          <svg class="site-w-4 site-h-4 site-text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
          </svg>
        </div>
      </div>
      <div class="site-ml-4">
        <p class="site-text-sm site-font-medium site-text-gray-600">Process Type</p>
        <p class="site-text-xl site-font-bold site-text-gray-900 site-capitalize"><%= @workflow.process_type.humanize %></p>
      </div>
    </div>
  </div>
  
  <div class="bg-white p-6 rounded-lg shadow border">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd"></path>
          </svg>
        </div>
      </div>
      <div class="ml-4">
        <p class="text-sm font-medium text-gray-600">Active Triggers</p>
        <p class="text-xl font-bold text-gray-900"><%= @triggers.count %></p>
      </div>
    </div>
  </div>
  
  <div class="bg-white p-6 rounded-lg shadow border">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
          </svg>
        </div>
      </div>
      <div class="ml-4">
        <p class="text-sm font-medium text-gray-600">Total Nodes</p>
        <p class="text-xl font-bold text-gray-900">
          <%= @triggers.values.sum { |trigger| trigger['nodes']&.count || 0 } %>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Triggers List -->
<div class="bg-white rounded-lg shadow border">
  <div class="p-6 border-b border-gray-200">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900">Workflow Triggers</h3>
      <a href="<%= edit_admin_business_process_workflow_path(@workflow) %>" class="text-blue-600 hover:text-blue-500 text-sm font-medium">
        Edit Triggers
      </a>
    </div>
  </div>
  
  <% if @triggers.any? %>
    <div class="divide-y divide-gray-200">
      <% @triggers.each do |trigger_name, trigger_data| %>
        <div class="p-6">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h4 class="text-lg font-medium text-gray-900 mb-2">
                <%= trigger_name.humanize %>
              </h4>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <p class="text-sm text-gray-600">
                    <span class="font-medium">Nodes:</span> <%= trigger_data['nodes']&.count || 0 %>
                  </p>
                  <p class="text-sm text-gray-600">
                    <span class="font-medium">Connections:</span> <%= trigger_data['connections']&.count || 0 %>
                  </p>
                </div>
                
                <% if trigger_data['source'] %>
                  <div>
                    <p class="text-sm text-gray-600">
                      <span class="font-medium">Source:</span> 
                      <%= trigger_data['source']['name'] %> 
                      <span class="text-gray-500">(EmailWorkflow #<%= trigger_data['source']['email_workflow_id'] %>)</span>
                    </p>
                  </div>
                <% end %>
              </div>
              
              <!-- Node Flow Visualization -->
              <% if trigger_data['nodes']&.any? %>
                <div class="mb-4">
                  <p class="text-sm font-medium text-gray-700 mb-2">Node Flow:</p>
                  <div class="flex flex-wrap items-center gap-2">
                    <% trigger_data['nodes'].each_with_index do |node, index| %>
                      <div class="flex items-center">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium <%= node_type_color(node['type']) %>">
                          <%= node['type']&.humanize || 'Unknown' %>
                        </span>
                        <% if index < trigger_data['nodes'].count - 1 %>
                          <svg class="w-4 h-4 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 111.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                          </svg>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
              
              <!-- Trigger Configuration -->
              <% if trigger_data['nodes']&.first&.dig('config')&.any? %>
                <div>
                  <p class="text-sm font-medium text-gray-700 mb-2">Trigger Configuration:</p>
                  <div class="bg-gray-50 rounded p-3">
                    <% trigger_data['nodes'].first['config'].each do |key, value| %>
                      <p class="text-xs text-gray-600">
                        <span class="font-medium"><%= key.humanize %>:</span> 
                        <%= value.is_a?(Hash) ? value.to_json : value %>
                      </p>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
            
            <div class="flex items-center space-x-2 ml-4">
              <a href="<%= edit_admin_business_process_workflow_path(@workflow, trigger: trigger_name) %>" 
                 class="text-blue-600 hover:text-blue-500 text-sm font-medium">
                Edit
              </a>
              <%= button_to admin_business_process_workflow_path(@workflow, trigger_name: trigger_name), 
                            method: :delete, 
                            data: { 
                              confirm: "Remove trigger '#{trigger_name}'? This cannot be undone.",
                              turbo_method: :delete 
                            },
                            class: "text-red-600 hover:text-red-500 text-sm font-medium" do %>
                Remove
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
        <path d="M34 40h10v-4a6 6 0 00-10.712-3.714M34 40H14m20 0v-4a9.971 9.971 0 00-.712-3.714M14 40H4v-4a6 6 0 0110.713-3.714M14 40v-4c0-1.313.253-2.566.713-3.714m0 0A10.003 10.003 0 0124 26c4.21 0 7.813 2.602 9.288 6.286M30 14a6 6 0 11-12 0 6 6 0 0112 0zm12 6a4 4 0 11-8 0 4 4 0 018 0zm-28 0a4 4 0 11-8 0 4 4 0 018 0z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No triggers configured</h3>
      <p class="mt-1 text-sm text-gray-500">Get started by adding your first workflow trigger.</p>
      <div class="mt-6">
        <a href="<%= edit_admin_business_process_workflow_path(@workflow) %>" 
           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
          Add Trigger
        </a>
      </div>
    </div>
  <% end %>
</div>

<%
  def node_type_color(type)
    case type&.downcase
    when 'trigger'
      'bg-blue-100 text-blue-800'
    when 'email', 'send_email'
      'bg-green-100 text-green-800'
    when 'delay', 'wait'
      'bg-yellow-100 text-yellow-800'
    when 'condition'
      'bg-purple-100 text-purple-800'
    when 'webhook'
      'bg-orange-100 text-orange-800'
    else
      'bg-gray-100 text-gray-800'
    end
  end
%>