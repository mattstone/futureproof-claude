<!-- Update the message form with validation errors -->
<%= turbo_stream.update "message-form" do %>
  <%= form_with(model: [:admin, @contract, @new_message], 
                url: create_message_admin_contract_path(@contract), 
                local: true, class: "message-form", data: { turbo: true }) do |form| %>
    
    <%= hidden_field_tag :from_view, controller.action_name %>
    
    <!-- AI Agent Selection -->
    <div class="field ai-agent-selection" style="margin-bottom: 24px;">
      <%= form.label :ai_agent_id, "Send message as:" %>
      <%= form.select :ai_agent_id, 
          options_from_collection_for_select(@ai_agents, :id, :display_name, @new_message.ai_agent_id),
          { prompt: 'Select AI Agent...' },
          { class: "admin-form-select", required: true, onchange: "updateAgentPreview(this)" } %>
      
      <small class="field-hint">
        Customer will see this message as coming from the selected AI agent
      </small>
    </div>
    
    <% if @new_message.errors.any? %>
      <div class="alert alert-danger">
        <ul style="margin: 0; padding-left: 20px;">
          <% @new_message.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field">
      <%= form.label :subject %>
      <%= form.text_field :subject, placeholder: "Message subject...", required: true, class: @new_message.errors[:subject].any? ? "error" : "" %>
      <% if @new_message.errors[:subject].any? %>
        <div class="field-error"><%= @new_message.errors[:subject].first %></div>
      <% end %>
    </div>

    <!-- Field Helper Buttons -->
    <div class="field-helpers">
      <h4>Quick Insert:</h4>
      <div class="helper-buttons">
        <button type="button" onclick="insertField('{{user.first_name}}')" class="helper-btn">Customer Name</button>
        <button type="button" onclick="insertField('{{contract.status_display}}')" class="helper-btn">Contract Status</button>
        <button type="button" onclick="insertField('{{contract.start_date}}')" class="helper-btn">Start Date</button>
        <button type="button" onclick="insertField('{{contract.end_date}}')" class="helper-btn">End Date</button>
        <button type="button" onclick="insertField('{{application.address}}')" class="helper-btn">Property Address</button>
        <button type="button" onclick="insertField('{{application.formatted_home_value}}')" class="helper-btn">Home Value</button>
      </div>
    </div>

    <div class="field">
      <%= form.label :content, "Message" %>
      
      <!-- WYSIWYG Toolbar -->
      <div class="wysiwyg-toolbar">
        <button type="button" class="toolbar-btn" onclick="applyMarkup('**', '**')" title="Bold">
          <strong>B</strong>
        </button>
        <button type="button" class="toolbar-btn" onclick="applyMarkup('*', '*')" title="Italic">
          <em>I</em>
        </button>
        <button type="button" class="toolbar-btn" onclick="applyMarkup('- ', '')" title="Bullet Point">
          â€¢
        </button>
        <button type="button" class="toolbar-btn" onclick="applyMarkup('1. ', '')" title="Numbered List">
          1.
        </button>
        <button type="button" class="toolbar-btn" onclick="insertLineBreak()" title="Line Break">
          â†©
        </button>
      </div>
      
      <%= form.text_area :content, rows: 8, class: "markup-editor #{'error' if @new_message.errors[:content].any?}", 
                         placeholder: "Type your message here...", 
                         required: true %>
      <% if @new_message.errors[:content].any? %>
        <div class="field-error"><%= @new_message.errors[:content].first %></div>
      <% end %>
      <small class="field-hint">
        Select text and use formatting buttons above, or type markup directly: **bold**, *italic*, - bullet points
      </small>
    </div>

    <!-- Message Actions -->
    <div class="message-actions-container">
      <div class="actions-header">ðŸ“¤ Ready to send your message?</div>
      <div class="actions-description">Choose how you want to handle this message:</div>
      
      <div class="actions-buttons">
        <%= form.submit "Save as Draft", name: "save_draft", class: "admin-btn admin-btn-secondary draft-btn" %>
        <%= form.submit "Send Message Now", name: "send_now", class: "admin-btn admin-btn-primary send-btn" %>
      </div>
      
      <div class="actions-tip">
        ðŸ’¡ <strong>Tip:</strong> Save as draft to review later, or send now to deliver immediately to the customer.
      </div>
    </div>
  <% end %>
<% end %>