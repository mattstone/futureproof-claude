<% content_for :page_title, "#{@lender_clause.title} - #{@lender.name}" %>

<div class="admin-actions-bar">
  <div>
    <%= link_to "← Back to Clauses", admin_lender_lender_clauses_path(@lender), class: "admin-btn admin-btn-secondary" %>
  </div>
  
  <div class="admin-actions">
    <% if @lender_clause.draft? %>
      <%= link_to "Edit", edit_admin_lender_lender_clause_path(@lender, @lender_clause), class: "admin-btn admin-btn-primary" %>
      <%= button_to "Publish", publish_admin_lender_lender_clause_path(@lender, @lender_clause), 
          method: :patch, 
          data: { 
            confirm: "Are you sure you want to publish this clause? Published clauses cannot be edited."
          },
          class: "admin-btn admin-btn-info" %>
      <%= button_to "Delete", admin_lender_lender_clause_path(@lender, @lender_clause), 
          method: :delete, 
          data: { 
            confirm: "Are you sure you want to delete this clause? This action cannot be undone."
          },
          class: "admin-btn admin-btn-danger" %>
    <% elsif @lender_clause.published? && !@lender_clause.is_active? %>
      <%= button_to "Activate", activate_admin_lender_lender_clause_path(@lender, @lender_clause), 
          method: :patch, 
          data: { 
            confirm: "Are you sure you want to activate this clause? This will deactivate any currently active clause."
          },
          class: "admin-btn admin-btn-success" %>
    <% elsif @lender_clause.is_active? %>
      <%= button_to "Deactivate", deactivate_admin_lender_lender_clause_path(@lender, @lender_clause), 
          method: :patch, 
          data: { 
            confirm: "Are you sure you want to deactivate this clause?"
          },
          class: "admin-btn admin-btn-warning" %>
    <% end %>
  </div>
</div>

<div class="admin-clause-overview">
  <div class="admin-overview-header">
    <div class="admin-clause-title-section">
      <h2><%= @lender_clause.title %></h2>
      <div class="admin-clause-meta">
        <span class="version-badge">v<%= @lender_clause.version %></span>
        <span class="status-badge status-<%= @lender_clause.status_color %>">
          <%= @lender_clause.status %>
        </span>
      </div>
    </div>
    <div class="admin-clause-info">
      <div class="admin-info-item">
        <span class="admin-info-label">Lender:</span>
        <span class="admin-info-value"><%= @lender.name %></span>
      </div>
      <div class="admin-info-item">
        <span class="admin-info-label">Last Updated:</span>
        <span class="admin-info-value"><%= @lender_clause.formatted_last_updated %></span>
      </div>
      <% if @lender_clause.created_by %>
        <div class="admin-info-item">
          <span class="admin-info-label">Created By:</span>
          <span class="admin-info-value"><%= @lender_clause.created_by.full_name %></span>
        </div>
      <% end %>
    </div>
  </div>
  
  <% if @lender_clause.description.present? %>
    <div class="admin-clause-description">
      <h4>Description</h4>
      <p><%= @lender_clause.description %></p>
    </div>
  <% end %>
</div>

<!-- Clause Content -->
<div class="admin-clause-content-section">
  <h3>Clause Content</h3>
  <div class="admin-content-tabs" data-controller="tabs">
    <div class="admin-tab-buttons">
      <button class="admin-tab-button active" data-tabs-target="button" data-action="click->tabs#switch" data-tab="rendered">
        Rendered View
      </button>
      <button class="admin-tab-button" data-tabs-target="button" data-action="click->tabs#switch" data-tab="source">
        Source Code
      </button>
    </div>
    
    <div class="admin-tab-content">
      <div class="admin-tab-panel active" data-tabs-target="panel" data-tab="rendered">
        <div class="admin-rendered-content">
          <%= @lender_clause.rendered_preview_content.html_safe %>
        </div>
      </div>
      
      <div class="admin-tab-panel" data-tabs-target="panel" data-tab="source">
        <div class="admin-source-content">
          <pre><code><%= @lender_clause.content %></code></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Contract Usage -->
<div class="admin-contract-usage-section">
  <h3>Contract Usage</h3>
  
  <% if @contract_usages.any? %>
    <div class="admin-usage-summary">
      <div class="admin-summary-stats">
        <div class="admin-stat-item">
          <span class="admin-stat-value"><%= @contract_usages.count %></span>
          <span class="admin-stat-label">Total Usages</span>
        </div>
        <div class="admin-stat-item">
          <span class="admin-stat-value"><%= @contract_usages.active.count %></span>
          <span class="admin-stat-label">Active</span>
        </div>
        <div class="admin-stat-item">
          <span class="admin-stat-value"><%= @contract_usages.inactive.count %></span>
          <span class="admin-stat-label">Removed</span>
        </div>
      </div>
    </div>
    
    <div class="admin-usage-list">
      <% @contract_usages.order(:added_at).each do |usage| %>
        <div class="admin-usage-item">
          <div class="admin-usage-header">
            <div class="admin-usage-contract">
              <h5>
                <%= link_to usage.mortgage_contract.title, 
                    admin_mortgage_mortgage_contract_path(usage.mortgage_contract.mortgage, usage.mortgage_contract),
                    class: "admin-contract-link" %>
              </h5>
              <div class="admin-contract-info">
                <span class="admin-contract-version">Contract v<%= usage.contract_version_at_usage %></span>
                <span class="admin-clause-version">Clause v<%= usage.clause_version_at_usage %></span>
              </div>
            </div>
            
            <div class="admin-usage-status">
              <span class="status-badge <%= usage.active? ? 'status-active' : 'status-inactive' %>">
                <%= usage.active? ? 'Active' : 'Removed' %>
              </span>
              <span class="admin-position-badge">
                <%= usage.clause_position.name %>
              </span>
            </div>
          </div>
          
          <div class="usage-details">
            <div class="admin-usage-timeline">
              <div class="admin-timeline-item">
                <span class="admin-timeline-label">Added:</span>
                <span class="admin-timeline-value">
                  <%= usage.formatted_added_at %>
                  <% if usage.added_by %>
                    by <%= usage.added_by_name %>
                  <% end %>
                </span>
              </div>
              
              <% if usage.removed? %>
                <div class="admin-timeline-item">
                  <span class="admin-timeline-label">Removed:</span>
                  <span class="admin-timeline-value">
                    <%= usage.formatted_removed_at %>
                    <% if usage.removed_by %>
                      by <%= usage.removed_by_name %>
                    <% end %>
                  </span>
                </div>
                
                <% if usage.duration_active %>
                  <div class="admin-timeline-item">
                    <span class="admin-timeline-label">Duration:</span>
                    <span class="admin-timeline-value"><%= usage.duration_active %></span>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="admin-empty-usage">
      <div class="admin-empty-icon">📄</div>
      <h5>No Contract Usage Yet</h5>
      <p>This clause hasn't been added to any contracts yet.</p>
      <% if @lender_clause.is_active? %>
        <p class="admin-usage-hint">Since this clause is active, it can be added to contracts from the mortgage contract view.</p>
      <% elsif @lender_clause.published? %>
        <p class="admin-usage-hint">Activate this clause to make it available for adding to contracts.</p>
      <% else %>
        <p class="admin-usage-hint">Publish and activate this clause to make it available for adding to contracts.</p>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Insertion Points Reference -->
<div class="admin-insertion-points-section">
  <h3>Available Insertion Points</h3>
  <div class="admin-positions-grid">
    <% @clause_positions.each do |position| %>
      <div class="admin-position-card">
        <h5><%= position.name %></h5>
        <p><%= position.description %></p>
        <div class="admin-position-meta">
          <span class="admin-order-badge">Order: <%= position.display_order %></span>
        </div>
      </div>
    <% end %>
  </div>
</div>


