<% content_for :page_title, "Privacy Policy Preview" %>

<div class="admin-content-header">
  <div class="admin-content-title">
    <p>
      Last updated: <%= @privacy_policy.formatted_last_updated %>
      <% if @privacy_policy.is_active? %>
        <span class="admin-badge admin-badge-success">Active</span>
      <% else %>
        <span class="admin-badge admin-badge-secondary">Draft</span>
      <% end %>
    </p>
    <div class="admin-spacer-16"></div>
  </div>
  <div class="admin-content-actions">
    <%= link_to "Edit", edit_admin_privacy_policy_path(@privacy_policy), class: "admin-btn admin-btn-primary" %>
    <% unless @privacy_policy.is_active? %>
      <%= link_to "Activate This Version", 
          activate_admin_privacy_policy_path(@privacy_policy), 
          method: :patch,
          class: "admin-btn admin-btn-success",
          data: { 
            confirm: "Are you sure you want to activate this version? This will deactivate the current active version." 
          } %>
    <% end %>
    <%= link_to "← Back to Privacy Policies", admin_privacy_policies_path, class: "admin-btn admin-btn-secondary" %>
  </div>
</div>

<div class="admin-preview-container">
  <div class="legal-page">
    <div class="legal-container">
      <h1><%= @privacy_policy.title %></h1>
      <p class="last-updated">Last updated: <%= @privacy_policy.formatted_last_updated %></p>

      <div class="legal-content">
        <%= raw @privacy_policy.rendered_content %>
      </div>
    </div>
  </div>
</div>

<!-- Audit History Section -->
<div class="admin-content-section admin-spacer-40">
  <div class="admin-content-header">
    <div class="admin-content-title">
      <h2 class="admin-change-history-title">Change History</h2>
      <div class="admin-spacer-8"></div>
    </div>
  </div>

  <div class="admin-audit-history-container">
    <% if @audit_history.any? %>
      <div class="admin-audit-timeline">
        <% @audit_history.each do |version| %>
          <div class="admin-audit-entry">
            <div class="admin-audit-icon">
              <% case version.action %>
              <% when 'created' %>
                <span class="admin-audit-icon-created">➕</span>
              <% when 'updated' %>
                <span class="admin-audit-icon-updated">✏️</span>
              <% when 'activated' %>
                <span class="admin-audit-icon-activated">✅</span>
              <% end %>
            </div>
            
            <div class="admin-audit-content">
              <div class="admin-audit-header">
                <h4 class="admin-audit-action"><%= version.action_description %></h4>
                <span class="admin-audit-date"><%= version.formatted_created_at %></span>
              </div>
              
              <div class="admin-audit-details">
                <p class="admin-audit-user">
                  <strong><%= version.user.display_name %></strong>
                  <span class="admin-audit-email">(<%= version.user.email %>)</span>
                </p>
                
                <% if version.action == 'updated' && version.has_content_changes? %>
                  <div class="admin-content-diff-container">
                    <details class="admin-content-diff-details">
                      <summary class="admin-content-diff-summary">Changes</summary>
                      <div class="admin-content-diff">
                        <div class="admin-diff-viewer">
                          <% version.content_diff.each do |diff_line| %>
                            <div class="admin-diff-line admin-diff-<%= diff_line[:type] %>">
                              <% case diff_line[:type] %>
                              <% when :added %>
                                <span class="admin-diff-marker">+</span>
                                <span class="admin-diff-text"><%= diff_line[:content] %></span>
                              <% when :removed %>
                                <span class="admin-diff-marker">-</span>
                                <span class="admin-diff-text"><%= diff_line[:content] %></span>
                              <% when :unchanged %>
                                <span class="admin-diff-marker"> </span>
                                <span class="admin-diff-text"><%= diff_line[:content] %></span>
                              <% when :context %>
                                <span class="admin-diff-marker">⋯</span>
                                <span class="admin-diff-text admin-context-text"><%= diff_line[:content] %></span>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    </details>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Pagination -->
      <% if @audit_history.respond_to?(:current_page) && @audit_history.total_pages > 1 %>
        <div class="admin-audit-pagination">
          <div class="admin-actions admin-actions-center">
            <% if @audit_history.prev_page %>
              <%= link_to "← Previous", 
                  admin_privacy_policy_path(@privacy_policy, page: @audit_history.prev_page), 
                  class: "admin-btn admin-btn-secondary" %>
            <% end %>
            
            <span class="admin-text-muted">
              Page <%= @audit_history.current_page %> of <%= @audit_history.total_pages %>
            </span>
            
            <% if @audit_history.next_page %>
              <%= link_to "Next →", 
                  admin_privacy_policy_path(@privacy_policy, page: @audit_history.next_page), 
                  class: "admin-btn admin-btn-secondary" %>
            <% end %>
          </div>
        </div>
      <% end %>
      
    <% else %>
      <div class="admin-audit-empty-state">
        <p>No change history available for this Privacy Policy document.</p>
      </div>
    <% end %>
  </div>
</div>

