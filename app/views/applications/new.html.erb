<%= render 'shared/header' %>

<div class="application-page">
  <div class="application-container">
    <div class="application-card">
      <div class="application-header">
        <div class="step-indicator">
          <div class="step-progress">
            <div class="step-item completed">
              <div class="step-number">1</div>
              <div class="step-label">Account Created</div>
            </div>
            <div class="step-connector"></div>
            <div class="step-item active">
              <div class="step-number">2</div>
              <div class="step-label">Property Details</div>
            </div>
            <div class="step-connector"></div>
            <div class="step-item">
              <div class="step-number">3</div>
              <div class="step-label">Income & Loan</div>
            </div>
            <div class="step-connector"></div>
            <div class="step-item">
              <div class="step-number">4</div>
              <div class="step-label">Pre-approval</div>
            </div>
          </div>
        </div>
        <h1 class="application-title">Property Details</h1>
        <p class="application-subtitle">Tell us about your property to calculate your potential monthly income</p>
      </div>

      <div class="application-form">
        <%= form_with model: @application, local: true, html: {
              class: "application-form-inner",
              data: { controller: "application-form application-value property-autocomplete",
                      property_autocomplete_url_value: autocomplete_applications_path,
                      property_autocomplete_min_chars_value: 3 }
            } do |f| %>
          
          <%= render "shared/error_messages", resource: @application %>

          <div class="form-section">
            <h3 class="form-section-title">Property Information</h3>
            
            <div class="form-group">
              <%= f.label :address, "Property Address", class: "form-label" %>
              <div class="autocomplete-container">
                <%= f.text_field :address,
                    placeholder: "Start typing a property address (3+ characters for suggestions)...",
                    class: "form-input autocomplete-input",
                    data: {
                      property_autocomplete_target: "input",
                      action: "input->property-autocomplete#input keydown->property-autocomplete#keydown"
                    },
                    value: @application.address,
                    autocomplete: "off" %>

                <div class="autocomplete-suggestions"
                     data-property-autocomplete-target="suggestions"
                     data-action="click->property-autocomplete#clickItem">
                </div>
              </div>
              <small class="form-hint">Type 3 or more characters to see dynamic property suggestions</small>

              <!-- Property Details Preview (shown when CoreLogic data is available) -->
              <div class="property-preview <%= @application.corelogic_data_hash.present? ? 'visible' : '' %>"
                   data-property-autocomplete-target="propertyPreview">

                <div class="property-preview-header">
                  <h4 class="property-preview-title">Property Information</h4>
                  <div class="property-preview-subtitle"><%= @application.property_type.present? ? @application.property_type.humanize : 'Property' %></div>
                </div>

                <div class="property-preview-content">
                  <!-- Property Images Gallery -->
                  <% if @application.property_images_array.any? %>
                    <div class="property-images-section">
                      <div class="property-images-gallery">
                        <div class="property-image-main">
                          <img src="<%= @application.property_images_array.first %>"
                               alt="Property main image"
                               class="property-image-primary"
                               data-property-autocomplete-target="primaryImage">
                        </div>
                        <% if @application.property_images_array.length > 1 %>
                          <div class="property-image-thumbnails">
                            <% @application.property_images_array.each_with_index do |image_url, index| %>
                              <div class="property-image-thumb <%= index == 0 ? 'active' : '' %>"
                                   data-action="click->property-autocomplete#selectImage"
                                   data-index="<%= index %>"
                                   data-image-url="<%= image_url %>">
                                <img src="<%= image_url %>" alt="Property image <%= index + 1 %>">
                              </div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>

                  <!-- Property Details -->
                  <div class="property-details-section">
                    <div class="property-details-grid">
                      <% if @application.has_property_valuation? %>
                        <div class="property-detail-item">
                          <div class="property-detail-label">Valuation</div>
                          <div class="property-detail-value primary-value">
                            <%= @application.formatted_property_valuation_middle %>
                          </div>
                          <div class="property-detail-range">
                            Range: <%= @application.formatted_property_valuation_range %>
                          </div>
                        </div>
                      <% end %>


                      <% if @application.corelogic_data_hash['land_area'].present? %>
                        <div class="property-detail-item">
                          <div class="property-detail-label">Land Area</div>
                          <div class="property-detail-value">
                            <%= @application.corelogic_data_hash['land_area'] %> m²
                          </div>
                        </div>
                      <% end %>

                      <% if @application.corelogic_data_hash['building_area'].present? %>
                        <div class="property-detail-item">
                          <div class="property-detail-label">Building Area</div>
                          <div class="property-detail-value">
                            <%= @application.corelogic_data_hash['building_area'] %> m²
                          </div>
                        </div>
                      <% end %>

                      <% if @application.corelogic_data_hash['year_built'].present? %>
                        <div class="property-detail-item">
                          <div class="property-detail-label">Year Built</div>
                          <div class="property-detail-value">
                            <%= @application.corelogic_data_hash['year_built'] %>
                          </div>
                        </div>
                      <% end %>

                      <% if @application.property_type.present? %>
                        <div class="property-detail-item">
                          <div class="property-detail-label">Property Type</div>
                          <div class="property-detail-value">
                            <%= @application.property_type.humanize %>
                          </div>
                        </div>
                      <% end %>
                    </div>

                    <div class="property-valuation-notice">
                      <svg class="property-notice-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                      <span>Property value has been set to the average valuation for this property. You may change this value, however a 3rd party property valuation will be required.</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Hidden fields for CoreLogic data -->
              <%= f.hidden_field :property_id, data: { property_autocomplete_target: "propertyId" } %>
              <%= f.hidden_field :property_type, data: { field: "property_type" } %>
              <%= f.hidden_field :property_images, data: { field: "property_images" } %>
              <%= f.hidden_field :property_valuation_low, data: { field: "property_valuation_low" } %>
              <%= f.hidden_field :property_valuation_middle, data: { field: "property_valuation_middle" } %>
              <%= f.hidden_field :property_valuation_high, data: { field: "property_valuation_high" } %>
              <%= f.hidden_field :corelogic_data, data: { field: "corelogic_data" } %>
            </div>

            <div class="form-group">
              <%= f.label :home_value, "Estimated Property Value", class: "form-label" %>
              <div class="slider-container">
                <%= f.range_field :home_value,
                    min: 1000000,
                    max: 10000000,
                    step: 50000,
                    value: @application.home_value || 1500000,
                    class: "value-slider",
                    data: {
                      "application-form-target": "homeValueSlider",
                      "application-value-target": "homeValueSlider",
                      "property-autocomplete-target": "homeValue",
                      "action": "input->application-form#updateHomeValue"
                    } %>
                <div class="slider-value" data-application-form-target="homeValueDisplay" data-application-value-target="homeValueDisplay">
                  <%= number_to_currency(@application.home_value || 1500000, precision: 0) %>
                </div>
              </div>
              <div class="form-hint">Adjust the slider to set your estimated property value</div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <%= f.label :ownership_status, "Ownership", class: "form-label" %>
                <%= f.select :ownership_status,
                    options_for_select([
                      ['Individual', 'individual'],
                      ['Joint Ownership', 'joint'],
                      ['Superannuation Fund', 'super']
                    ], @application.ownership_status),
                    {},
                    {
                      class: "form-select",
                      data: {
                        "application-form-target": "ownershipSelect",
                        "action": "change->application-form#toggleOwnershipFields change->application-form#autoSave"
                      }
                    } %>
              </div>

              <div class="form-group">
                <%= f.label :property_state, "Property Type", class: "form-label" %>
                <%= f.select :property_state,
                    options_for_select([
                      ['Primary Residence', 'primary_residence'],
                      ['Investment Property', 'investment'],
                      ['Holiday Home', 'holiday']
                    ], @application.property_state),
                    {},
                    { class: "form-select" } %>
              </div>
            </div>

            <!-- Individual ownership: Show borrower name and age -->
            <div class="form-group <%= @application.ownership_status.to_s == 'individual' ? '' : 'js-hidden' %>"
                 data-application-form-target="individualFields">
              <%= f.label :borrower_names, "Borrower Name", class: "form-label" %>
              <%= f.text_field :borrower_names,
                  class: "form-input",
                  placeholder: "Enter borrower name" %>

              <%= f.label :borrower_age, "Age of Borrower", class: "form-label" %>
              <div class="slider-container">
                <%= f.range_field :borrower_age,
                    min: 18,
                    max: 85,
                    step: 1,
                    value: @application.borrower_age || 60,
                    class: "value-slider",
                    data: {
                      "application-form-target": "borrowerAgeSlider",
                      "action": "input->application-form#updateBorrowerAge"
                    } %>
                <div class="slider-value" data-application-form-target="borrowerAgeDisplay">
                  <%= @application.borrower_age || 60 %> years
                </div>
              </div>
              <div class="form-hint">Adjust the slider to set your age</div>
            </div>

            <!-- Joint ownership: Show borrower names and ages -->
            <div class="form-group <%= @application.ownership_status.to_s == 'joint' ? '' : 'js-hidden' %>"
                 data-application-form-target="jointFields">
              <label class="form-label">Borrower Details</label>
              <div id="joint-borrowers">
                <div class="joint-borrower-item">
                  <div class="joint-borrower-row">
                    <div class="joint-borrower-name">
                      <input type="text" name="borrower_name_1" placeholder="First borrower name" class="form-input">
                    </div>
                    <div class="joint-borrower-age">
                      <div class="joint-age-slider-container">
                        <input type="range" name="borrower_age_1" min="18" max="85" step="1" value="60" class="joint-age-slider" data-borrower-index="1">
                        <div class="joint-age-display" data-age-display="1">60 years</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="joint-borrower-item">
                  <div class="joint-borrower-row">
                    <div class="joint-borrower-name">
                      <input type="text" name="borrower_name_2" placeholder="Second borrower name" class="form-input">
                    </div>
                    <div class="joint-borrower-age">
                      <div class="joint-age-slider-container">
                        <input type="range" name="borrower_age_2" min="18" max="85" step="1" value="60" class="joint-age-slider" data-borrower-index="2">
                        <div class="joint-age-display" data-age-display="2">60 years</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <button type="button" id="add-borrower" class="site-btn site-btn-secondary site-btn-sm site-mt-2">Add Another Borrower</button>
              <%= f.hidden_field :borrower_names, data: { "application-form-target": "borrowerNamesHidden" } %>
            </div>


            <!-- Superannuation ownership: Show super fund name -->
            <div class="form-group <%= @application.ownership_status.to_s == 'super' ? '' : 'js-hidden' %>"
                 data-application-form-target="superFields">
              <%= f.label :super_fund_name, "Superannuation Fund Name", class: "form-label" %>
              <%= f.text_field :super_fund_name, 
                  class: "form-input", 
                  placeholder: "Enter the superannuation fund name" %>
            </div>
          </div>

          <div class="form-section">
            <h3 class="form-section-title">Existing Mortgage</h3>
            
            <div class="form-group checkbox-group checkbox-group-reverse">
              <%= f.label :has_existing_mortgage, class: "checkbox-label" do %>
                This property has an existing mortgage
                <%= f.check_box :has_existing_mortgage,
                    class: "form-checkbox",
                    data: {
                      "application-form-target": "mortgageCheckbox",
                      "action": "change->application-form#toggleMortgageAmount change->application-form#autoSave"
                    } %>
              <% end %>
            </div>

            <div class="form-group mortgage-amount-group <%= @application.has_existing_mortgage? ? '' : 'js-hidden' %>"
                 data-application-form-target="mortgageAmountGroup">
              <%= f.label :existing_mortgage_amount, "Outstanding Mortgage Amount", class: "form-label" %>
              <div class="slider-container">
                <%= f.range_field :existing_mortgage_amount,
                    min: 10000,
                    max: 4000000,
                    step: 10000,
                    value: @application.has_existing_mortgage? ? (@application.existing_mortgage_amount || 500000) : 0,
                    class: "value-slider",
                    data: {
                      "application-form-target": "mortgageSlider",
                      "action": "input->application-form#updateMortgageAmount"
                    } %>
                <div class="slider-value" data-application-form-target="mortgageAmountDisplay">
                  <%= number_to_currency(@application.has_existing_mortgage? ? (@application.existing_mortgage_amount || 500000) : 0, precision: 0) %>
                </div>
              </div>
              <div class="form-hint">Adjust the slider to set your outstanding mortgage balance</div>
            </div>

            <div class="form-group <%= @application.has_existing_mortgage? ? '' : 'js-hidden' %>"
                 data-application-form-target="mortgageLenderGroup">
              <%= f.label :existing_mortgage_lender, "Current Mortgage Lender", class: "form-label" %>
              <%= f.text_field :existing_mortgage_lender,
                  class: "form-input",
                  placeholder: "Enter your current mortgage lender name" %>
            </div>
          </div>

          <div class="form-actions">
            <%= f.submit "Continue to Step 3", class: "site-btn site-btn-primary site-btn-lg application-submit-btn" %>
            <%= link_to "Back to Home", root_path, class: "site-btn site-btn-secondary" %>
          </div>
        <% end %>
      </div>

      <div class="application-footer">
        <p class="form-disclaimer">
          * All information provided will be kept confidential and used only for your mortgage application assessment.
        </p>
      </div>
    </div>
  </div>
</div>

<%= render 'shared/footer' %>