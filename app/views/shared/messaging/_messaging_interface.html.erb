<%
  # Determine the resource type and set variables accordingly
  if defined?(@application) && @application
    resource = @application
    resource_type = 'application'
    resource_name = 'application'
    messages = @messages || resource.message_threads
    new_message = @new_message || resource.application_messages.build
    create_message_path = create_message_admin_application_path(resource)
    send_message_path_proc = ->(message) { send_message_admin_application_path(resource, message_id: message.id) }
    context_name = 'application'
    context_status = resource.status_display
    quick_insert_fields = [
      ['Customer Name', '{{user.first_name}}'],
      ['Property Address', '{{application.address}}'],
      ['Home Value', '{{application.formatted_home_value}}'],
      ['Application Status', '{{application.status_display}}']
    ]
    greeting_context = 'application'
    javascript_data = {
      id: resource.id,
      address: resource.address,
      status: resource.status,
      statusDisplay: resource.status_display,
      formattedHomeValue: resource.formatted_home_value,
      user: {
        firstName: resource.user.first_name,
        lastName: resource.user.last_name,
        email: resource.user.email
      }
    }
  elsif defined?(@contract) && @contract
    resource = @contract
    resource_type = 'contract'
    resource_name = 'contract'
    messages = @messages || resource.message_threads
    new_message = @new_message || resource.contract_messages.build
    create_message_path = create_message_admin_contract_path(resource)
    send_message_path_proc = ->(message) { send_message_admin_contract_path(resource, message_id: message.id) }
    context_name = 'contract'
    context_status = resource.status.humanize
    quick_insert_fields = [
      ['Customer Name', '{{user.first_name}}'],
      ['Contract Status', '{{contract.status_display}}'],
      ['Start Date', '{{contract.start_date}}'],
      ['End Date', '{{contract.end_date}}'],
      ['Property Address', '{{application.address}}'],
      ['Home Value', '{{application.formatted_home_value}}']
    ]
    greeting_context = 'contract'
    javascript_data = {
      id: resource.id,
      status: resource.status,
      statusDisplay: resource.status.humanize,
      startDate: resource.start_date.strftime("%B %d, %Y"),
      endDate: resource.end_date.strftime("%B %d, %Y"),
      application: {
        address: resource.application.address,
        formattedHomeValue: resource.application.formatted_home_value
      },
      user: {
        firstName: resource.application.user.first_name,
        lastName: resource.application.user.last_name,
        email: resource.application.user.email
      }
    }
  else
    raise "Invalid resource: Expected @application or @contract to be defined"
  end
%>

<!-- Flash Messages Container -->
<div id="flash-messages"></div>

<!-- Send New Message Form -->
<div class="admin-form message-form-section" 
     data-controller="messaging"
     data-messaging-resource-type-value="<%= resource_type %>"
     data-messaging-resource-data-value="<%= javascript_data.to_json %>"
     data-messaging-ai-agent-data-value="<%= @ai_agents.map { |agent| { id: agent.id, name: agent.name, displayName: agent.display_name, roleDescription: agent.role_description, avatarPath: (agent.asset_avatar_path rescue nil), specialties: agent.specialties } }.to_json %>">
  
  <h3>Send Message to Customer 
    <span id="message-count" class="count-badge">
      <span class="message-count"><%= resource.respond_to?(:application_messages) ? resource.application_messages.sent.count : resource.contract_messages.sent.count %></span>
    </span>
    <span id="draft-count" class="count-badge draft">
      <span class="draft-count"><%= resource.respond_to?(:application_messages) ? resource.application_messages.drafts.count : resource.contract_messages.drafts.count %></span> drafts
    </span>
  </h3>
  <p class="section-subtitle">Communicate with the customer about their <%= context_name %></p>
  
  <div id="message-form">
    <%= form_with(model: [:admin, resource, new_message], 
                  url: create_message_path, 
                  local: true, class: "message-form", data: { turbo: true }) do |form| %>
    
    <%= hidden_field_tag :from_view, controller.action_name %>
    
    <!-- AI Agent Selection -->
    <div class="field ai-agent-selection">
      <%= form.label :ai_agent_id, "Send message as:" %>
      <%= form.select :ai_agent_id, 
          options_from_collection_for_select(@ai_agents, :id, :display_name, @suggested_agent&.id),
          { prompt: 'Select AI Agent...' },
          { class: "admin-form-select", required: true, 
            data: { messaging_target: "agentSelect", action: "change->messaging#agentChanged" } } %>
      
      <div id="agent-preview" class="agent-preview <%= 'visible' if @suggested_agent %>" 
           data-messaging-target="agentPreview">
        <div class="agent-info">
          <% if @suggested_agent %>
            <% begin %>
              <%= image_tag @suggested_agent.asset_avatar_path, 
                  alt: "#{@suggested_agent.name} Avatar", 
                  class: "agent-avatar" %>
            <% rescue => e %>
              <div class="agent-avatar agent-avatar-fallback">
                <%= @suggested_agent.name.first.upcase %>
              </div>
            <% end %>
          <% else %>
            <img class="agent-avatar" src="" alt="">
          <% end %>
          <div class="agent-details">
            <strong class="agent-name"><%= @suggested_agent&.display_name %></strong>
            <div class="agent-role"><%= @suggested_agent&.role_description %></div>
            <div class="agent-specialties">
              <% if @suggested_agent %>
                Specialties: <%= @suggested_agent.specialties || 'General assistance' %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      
      <small class="field-hint">
        Customer will see this message as coming from the selected AI agent
      </small>
    </div>
    
    <% if new_message.errors.any? %>
      <div class="alert alert-danger">
        <ul>
          <% new_message.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field">
      <%= form.label :subject %>
      <%= form.text_field :subject, placeholder: "Message subject...", required: true,
                         data: { messaging_target: "subjectInput" } %>
    </div>

    <!-- Field Helper Buttons -->
    <div class="field-helpers">
      <h4>Quick Insert:</h4>
      <div class="helper-buttons">
        <% quick_insert_fields.each do |label, field| %>
          <button type="button" class="helper-btn" 
                  data-field-value="<%= field %>"
                  data-action="click->messaging#insertField"><%= label %></button>
        <% end %>
      </div>
    </div>

    <div class="field">
      <%= form.label :content, "Message" %>
      
      <!-- WYSIWYG Toolbar -->
      <div class="wysiwyg-toolbar">
        <button type="button" class="toolbar-btn" 
                data-action="click->messaging#applyBold" title="Bold">
          <strong>B</strong>
        </button>
        <button type="button" class="toolbar-btn" 
                data-action="click->messaging#applyItalic" title="Italic">
          <em>I</em>
        </button>
        <button type="button" class="toolbar-btn" 
                data-action="click->messaging#applyBulletPoint" title="Bullet Point">
          ‚Ä¢
        </button>
        <button type="button" class="toolbar-btn" 
                data-action="click->messaging#applyNumberedList" title="Numbered List">
          1.
        </button>
        <button type="button" class="toolbar-btn" 
                data-action="click->messaging#insertLineBreak" title="Line Break">
          ‚Ü©
        </button>
      </div>
      
      <%= form.text_area :content, rows: 8, class: "markup-editor", 
                         placeholder: "Type your message here...\n\nSelect text and use the formatting buttons above, or type markup directly:\n**Bold text**\n*Italic text*\n- Bullet points", 
                         required: true,
                         data: { messaging_target: "contentInput" } %>
      <small class="field-hint">
        Select text and use formatting buttons above, or type markup directly: **bold**, *italic*, - bullet points
      </small>
    </div>

    <!-- Live Preview Section -->
    <div class="field live-preview-section">
      <label class="live-preview-label">Live Preview (Email Layout)</label>
      <div class="preview-disclaimer">
        <div class="preview-disclaimer-content">
          <span class="preview-disclaimer-icon">üëÅÔ∏è</span>
          <span class="preview-disclaimer-text">Preview Only - This shows how the email will appear to the customer</span>
        </div>
      </div>
      <div id="message-preview" class="message-preview" data-messaging-target="preview">
        
        <!-- Email Container Preview -->
        <div class="email-container">
          
          <!-- Lender Header (Blue) -->
          <div class="email-header">
            <h1>Futureproof Financial Group</h1>
            <p>Equity Preservation Mortgage ¬Æ</p>
          </div>
          
          <!-- Agent Header Section -->
          <div id="preview-agent-header" class="preview-agent-header" 
               data-messaging-target="previewAgentHeader">
            <div class="preview-agent-info">
              <img id="preview-agent-avatar" src="" alt="" 
                   class="preview-agent-avatar"
                   data-messaging-target="previewAgentAvatar" />
              <div id="preview-agent-fallback" class="preview-agent-fallback"
                   data-messaging-target="previewAgentFallback">
                ü§ñ
              </div>
              <div class="preview-agent-details">
                <h1 id="preview-agent-name" class="preview-agent-name"
                    data-messaging-target="previewAgentName">
                  Select an AI agent above
                </h1>
                <p id="preview-agent-role" class="preview-agent-role"
                   data-messaging-target="previewAgentRole">
                  AI Assistant
                </p>
                <p class="preview-agent-company">
                  Futureproof Financial Group
                </p>
              </div>
            </div>
          </div>
          
          <!-- Email Greeting -->
          <div class="email-greeting">
            <p>Dear [Customer Name],</p>
            <p>
              I hope this message finds you well. I'm reaching out to you regarding your 
              <%= greeting_context == 'application' ? "mortgage application" : "mortgage contract" %> 
              with Futureproof Financial Group.
            </p>
          </div>
          
          <!-- Email Content (Dynamic) -->
          <div class="email-content-wrapper">
            <div class="email-content-card">
              <!-- Subject Header -->
              <div class="email-content-header">
                <h2 id="preview-subject" class="email-content-subject"
                    data-messaging-target="previewSubject">
                  Enter a subject above
                </h2>
              </div>
              
              <!-- Message Body -->
              <div id="preview-content" class="email-content-body"
                   data-messaging-target="previewContent">
                <p>Type your message content above to see the preview...</p>
              </div>
            </div>
          </div>
          
          <!-- Email Footer -->
          <div class="email-footer">
            <div class="email-button">
              Reply to this message
              <div class="email-button-badge">
                1
              </div>
            </div>
            <div class="email-button-disclaimer">
              (This is just a preview - button is not functional)
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Actions -->
    <div class="message-actions-container">
      <div class="actions-header">Message Actions</div>
      <div class="actions-description">Choose how to handle this message</div>
      
      <div class="actions-buttons">
        <%= form.submit "Save as Draft", name: "draft", class: "admin-btn admin-btn-secondary draft-btn" %>
        <%= form.submit "Send Message", name: "send", class: "admin-btn admin-btn-success send-btn" %>
      </div>
      
      <div class="actions-tip">
        <strong>Tip:</strong> Save as draft to review later, or send immediately to the customer
      </div>
    </div>

    <% end %>
  </div>
</div>

<!-- Message History -->
<div class="message-history-section">
  <h3>Message History
    <span class="count-badge"><%= messages.count %></span>
  </h3>
  <div class="section-subtitle">Previous messages sent to and received from the customer</div>
  
  <% if messages.any? %>
    <div class="message-threads">
      <% messages.order(created_at: :desc).each do |message| %>
        <div class="message-thread">
          <div class="message-header">
            <div class="message-sender">
              <div class="sender-avatar <%= message.customer_message? ? 'customer-avatar' : 'admin-avatar' %>">
                <% if message.customer_message? %>
                  <%= resource.user.first_name.first.upcase %>
                <% else %>
                  <%= (message.ai_agent&.name&.first&.upcase) || 'A' %>
                <% end %>
              </div>
              <div class="sender-info">
                <div class="sender-name">
                  <% if message.customer_message? %>
                    <%= resource.user.display_name %> (Customer)
                  <% else %>
                    <%= message.ai_agent&.display_name || 'Admin' %>
                    <% if message.ai_agent %>
                      <span class="ai-badge">AI</span>
                    <% end %>
                  <% end %>
                </div>
                <div class="sender-role">
                  <% if message.customer_message? %>
                    Customer
                  <% else %>
                    <%= message.ai_agent&.role_description || 'Administrator' %>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="message-meta">
              <% unless message.customer_message? %>
                <span class="message-status status-<%= message.status %>">
                  <%= message.status %>
                </span>
              <% end %>
              <span class="message-time">
                <%= message.created_at.strftime("%B %d at %I:%M %p") %>
              </span>
            </div>
          </div>
          
          <% if message.subject.present? %>
            <div class="message-subject">
              <strong><%= message.subject %></strong>
            </div>
          <% end %>
          
          <div class="message-content">
            <%= simple_format(message.content) %>
          </div>
          
          <% if message.replies.any? %>
            <div class="message-replies">
              <h4>Customer Replies:</h4>
              <% message.replies.each do |reply| %>
                <div class="message-reply">
                  <div class="reply-header">
                    <strong><%= reply.user.display_name %></strong>
                    <span><%= reply.created_at.strftime("%B %d at %I:%M %p") %></span>
                  </div>
                  <div class="reply-content">
                    <%= simple_format(reply.content) %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
          
          <% unless message.customer_message? %>
            <div class="message-actions">
              <%= link_to "Send Message", send_message_path_proc.call(message), 
                         method: :post, 
                         data: { turbo: true },
                         class: "admin-btn admin-btn-primary admin-btn-sm #{'hidden' if message.sent?}" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="empty-state">
      <p>No messages yet. Use the form above to send the first message to the customer.</p>
    </div>
  <% end %>
</div>