<%= render 'shared/header' %>

<div class="auth-page">
  <div class="auth-container" data-controller="terms-modal">
    <div class="auth-card" data-controller="auth-form">
      <div class="auth-header">
        <h1 class="auth-title" data-auth-form-target="title">Create Account</h1>
        <p class="auth-subtitle" data-auth-form-target="subtitle">Start your journey with Equity Preservation Mortgage®</p>
      </div>

      <div class="form-toggle">
        <!-- Registration Form -->
        <div class="auth-form registration-form" data-auth-form-target="registrationForm">
          <%= form_for(resource, as: resource_name, url: registration_path(resource_name), local: true, html: { class: "auth-form-inner" }) do |f| %>
            <%= render "devise/shared/error_messages", resource: resource %>

            <div class="form-group">
              <%= f.label :first_name, class: "form-label" %>
              <%= f.text_field :first_name, class: "form-input", placeholder: "Enter your first name" %>
            </div>

            <div class="form-group">
              <%= f.label :last_name, class: "form-label" %>
              <%= f.text_field :last_name, class: "form-input", placeholder: "Enter your last name" %>
            </div>

            <div class="form-group">
              <%= f.label :email, class: "form-label" %>
              <%= f.email_field :email, 
                  class: "form-input", 
                  placeholder: "Enter your email address",
                  data: { 
                    "auth-form-target": "emailInput",
                    "action": "blur->auth-form#checkEmail change->auth-form#checkEmail"
                  } %>
              <div class="email-status" data-auth-form-target="emailStatus"></div>
            </div>

            <div class="form-group">
              <%= f.label :country_of_residence, "Country of Residence", class: "form-label" %>
              <%= f.select :country_of_residence, 
                  options_for_select([
                    ['🇦🇺 Australia', 'Australia'],
                    ['🇳🇿 New Zealand', 'New Zealand'],
                    ['🇺🇸 United States', 'United States'],
                    ['🇬🇧 United Kingdom', 'United Kingdom'],
                    ['🇨🇦 Canada', 'Canada'],
                    ['🇩🇪 Germany', 'Germany'],
                    ['🇫🇷 France', 'France'],
                    ['🇮🇹 Italy', 'Italy'],
                    ['🇪🇸 Spain', 'Spain'],
                    ['🇳🇱 Netherlands', 'Netherlands'],
                    ['🇧🇪 Belgium', 'Belgium'],
                    ['🇨🇭 Switzerland', 'Switzerland'],
                    ['🇦🇹 Austria', 'Austria'],
                    ['🇸🇪 Sweden', 'Sweden'],
                    ['🇳🇴 Norway', 'Norway'],
                    ['🇩🇰 Denmark', 'Denmark'],
                    ['🇫🇮 Finland', 'Finland'],
                    ['🇮🇪 Ireland', 'Ireland'],
                    ['🇯🇵 Japan', 'Japan'],
                    ['🇰🇷 South Korea', 'South Korea'],
                    ['🇸🇬 Singapore', 'Singapore'],
                    ['🇭🇰 Hong Kong', 'Hong Kong'],
                    ['🇨🇳 China', 'China'],
                    ['🇮🇳 India', 'India'],
                    ['🇧🇷 Brazil', 'Brazil'],
                    ['🇦🇷 Argentina', 'Argentina'],
                    ['🇨🇱 Chile', 'Chile'],
                    ['🇲🇽 Mexico', 'Mexico'],
                    ['🇿🇦 South Africa', 'South Africa'],
                    ['🇮🇱 Israel', 'Israel'],
                    ['🇦🇪 United Arab Emirates', 'United Arab Emirates'],
                    ['🌍 Other', 'Other']
                  ], 'Australia'), 
                  {}, 
                  { class: "form-select" } %>
            </div>

            <div class="form-group">
              <%= f.label :password, class: "form-label" %>
              <% if @minimum_password_length %>
                <span class="password-hint">(<%= @minimum_password_length %> characters minimum)</span>
              <% end %>
              <%= f.password_field :password, 
                  class: "form-input", 
                  placeholder: "Create a secure password",
                  autocomplete: "new-password" %>
            </div>

            <div class="form-group">
              <%= f.label :password_confirmation, "Confirm Password", class: "form-label" %>
              <%= f.password_field :password_confirmation, 
                  class: "form-input", 
                  placeholder: "Confirm your password",
                  autocomplete: "new-password" %>
            </div>

            <div class="form-group checkbox-group terms-checkbox-fix">
              <%= f.label :terms_accepted, class: "checkbox-label terms-inline" do %>
                <span class="checkbox-text">
                  I accept the
                  <button type="button" class="terms-link" data-action="click->terms-modal#open">
                    Terms and Conditions
                  </button>
                </span>
                <%= f.check_box :terms_accepted, class: "form-checkbox", required: true %>
              <% end %>
            </div>

            <div class="form-group recaptcha-group">
              <%= recaptcha_tags theme: 'light', size: 'normal' %>
            </div>

            <!-- Hidden field to preserve home_value through registration -->
            <% if params[:home_value].present? %>
              <%= hidden_field_tag :home_value, params[:home_value] %>
            <% end %>

            <div class="form-actions">
              <%= f.submit "Create Account", class: "site-btn site-btn-primary site-btn-lg auth-submit-btn site-btn-disabled", disabled: true %>
            </div>
          <% end %>
        </div>

        <!-- Login Form -->  
        <div class="auth-form login-form js-hidden" data-auth-form-target="loginForm">
          <%= form_for(resource, as: resource_name, url: session_path(resource_name), local: true, html: { class: "auth-form-inner", id: "login_form" }) do |f| %>

            <div class="form-group">
              <%= f.label :email, class: "form-label", for: "login_user_email" %>
              <%= f.email_field :email,
                  class: "form-input",
                  placeholder: "Enter your email address",
                  id: "login_user_email",
                  data: { "auth-form-target": "loginEmailInput" } %>
            </div>

            <div class="form-group">
              <%= f.label :password, class: "form-label", for: "login_user_password" %>
              <%= f.password_field :password,
                  class: "form-input",
                  placeholder: "Enter your password",
                  id: "login_user_password",
                  autocomplete: "current-password" %>
            </div>

            <% if devise_mapping.rememberable? %>
              <div class="form-group checkbox-group">
                <%= f.check_box :remember_me, class: "form-checkbox", id: "login_user_remember_me" %>
                <%= f.label :remember_me, "Remember me", class: "checkbox-label", for: "login_user_remember_me" %>
              </div>
            <% end %>

            <div class="form-actions">
              <%= f.submit "Sign In", class: "site-btn site-btn-primary site-btn-lg auth-submit-btn" %>
            </div>
          <% end %>
        </div>

        <!-- Toggle Links -->
        <div class="auth-toggle">
          <div class="toggle-to-login js-hidden" data-auth-form-target="toggleToLogin">
            <p class="toggle-text">Already have an account? 
              <button type="button" class="toggle-link" data-action="click->auth-form#showLogin">Sign In</button>
            </p>
          </div>
          
          <div class="toggle-to-register js-hidden" data-auth-form-target="toggleToRegister">
            <p class="toggle-text">Don't have an account? 
              <button type="button" class="toggle-link" data-action="click->auth-form#showRegistration">Create Account</button>
            </p>
          </div>
        </div>

        <!-- Additional Links -->
        <div class="auth-links">
          <div class="auth-links-row">
            <%= link_to "Forgot your password?", new_password_path(resource_name), class: "auth-link" %>
            <span class="auth-links-separator js-hidden" data-auth-form-target="linkSeparator"> | </span>
            <button type="button" class="auth-link-button js-hidden" data-auth-form-target="createAccountLink" data-action="click->auth-form#showRegistration">Create Account</button>
          </div>
        </div>
      </div>

      <div class="auth-footer">
        <p class="auth-disclaimer">
          Need help? Contact us or visit our 
          <%= link_to "Privacy Policy", privacy_policy_path, class: "auth-link" %>.
        </p>
        <%= link_to "← Back to Home", root_path, class: "back-link" %>
      </div>
    </div>

    <!-- Terms of Use Modal -->
    <div class="modal-overlay" data-terms-modal-target="overlay" data-action="click->terms-modal#close">
      <div class="modal-content" data-action="click->terms-modal#stopPropagation">
        <div class="modal-header">
          <h2 class="modal-title">Terms and Conditions</h2>
          <button type="button" class="modal-close" data-action="click->terms-modal#close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body" data-terms-modal-target="content">
          <div class="loading-spinner">Loading...</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="site-btn site-btn-secondary" data-action="click->terms-modal#close">Close</button>
          <button type="button" class="site-btn site-btn-primary" data-action="click->terms-modal#accept">Accept Terms</button>
        </div>
      </div>
    </div>
  </div>
</div>

<%= render 'shared/footer' %>